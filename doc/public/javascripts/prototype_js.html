<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>prototype.js - RDoc Documentation</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../../";
</script>

<script src="../../js/jquery.js"></script>
<script src="../../js/darkfish.js"></script>

<link href="../../css/fonts.css" rel="stylesheet">
<link href="../../css/rdoc.css" rel="stylesheet">



<body id="top" role="document" class="file">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../table_of_contents.html#pages">Pages</a>
    <a href="../../table_of_contents.html#classes">Classes</a>
    <a href="../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="project-metadata">
    <div id="fileindex-section" class="nav-section">
  <h3>Pages</h3>

  <ul class="link-list">
  
    <li><a href="../../Gemfile.html">Gemfile</a>
  
    <li><a href="../../Gemfile_lock.html">Gemfile.lock</a>
  
    <li><a href="../../README.html">README</a>
  
    <li><a href="../../Rakefile.html">Rakefile</a>
  
    <li><a href="../../app/flow_thoughts_txt.html">flow_thoughts</a>
  
    <li><a href="../../app/views/cost/_query_results_header_html_haml.html">_query_results_header.html.haml</a>
  
    <li><a href="../../app/views/cost/query_html_haml.html">query.html.haml</a>
  
    <li><a href="../../app/views/resource/_employee_details_html_haml.html">_employee_details.html.haml</a>
  
    <li><a href="../../app/views/resource/_not_key_html_haml.html">_not_key.html.haml</a>
  
    <li><a href="../../app/views/resource/_overbooked_html_haml.html">_overbooked.html.haml</a>
  
    <li><a href="../../app/views/resource/_pill_navigation_html_haml.html">_pill_navigation.html.haml</a>
  
    <li><a href="../../app/views/resource/_team_names_html_haml.html">_team_names.html.haml</a>
  
    <li><a href="../../app/views/resource/actual_html_haml.html">actual.html.haml</a>
  
    <li><a href="../../app/views/resource/availability_html_haml.html">availability.html.haml</a>
  
    <li><a href="../../app/views/resource/employee_view_html_haml.html">employee_view.html.haml</a>
  
    <li><a href="../../app/views/resource/key_project_summary_html_haml.html">key_project_summary.html.haml</a>
  
    <li><a href="../../app/views/resource/rule_check_html_haml.html">rule_check.html.haml</a>
  
    <li><a href="../../app/views/resource/variance_html_haml.html">variance.html.haml</a>
  
    <li><a href="../../app/views/users/INDEXH~1_BAK.html">INDEXH~1.BAK</a>
  
    <li><a href="../../config_ru.html">config.ru</a>
  
    <li><a href="../../importlogcsv_txt.html">importlogcsv</a>
  
    <li><a href="../../install.html">install</a>
  
    <li><a href="../../log/development_log.html">development.log</a>
  
    <li><a href="../../public/404_html.html">404.html</a>
  
    <li><a href="../../public/422_html.html">422.html</a>
  
    <li><a href="../../public/500_html.html">500.html</a>
  
    <li><a href="../../public/favicon_ico.html">favicon.ico</a>
  
    <li><a href="../../public/fonts/glyphicons-halflings-regular_svg.html">glyphicons-halflings-regular.svg</a>
  
    <li><a href="../../public/index_html.html">index.html</a>
  
    <li><a href="../../public/javascripts/application_js.html">application.js</a>
  
    <li><a href="../../public/javascripts/bootstrap_js.html">bootstrap.js</a>
  
    <li><a href="../../public/javascripts/bootstrap_min_js.html">bootstrap.min.js</a>
  
    <li><a href="../../public/javascripts/controls_js.html">controls.js</a>
  
    <li><a href="../../public/javascripts/dragdrop_js.html">dragdrop.js</a>
  
    <li><a href="../../public/javascripts/effects_js.html">effects.js</a>
  
    <li><a href="../../public/javascripts/prototype_js.html">prototype.js</a>
  
    <li><a href="../../public/javascripts/rails_js.html">rails.js</a>
  
    <li><a href="../../public/robots_txt.html">robots</a>
  
    <li><a href="../../public/stylesheets/application_css.html">application.css</a>
  
    <li><a href="../../public/stylesheets/bootstrap-responsive_css.html">bootstrap-responsive.css</a>
  
    <li><a href="../../public/stylesheets/bootstrap-responsive_min_css.html">bootstrap-responsive.min.css</a>
  
    <li><a href="../../public/stylesheets/bootstrap_css.html">bootstrap.css</a>
  
    <li><a href="../../public/stylesheets/bootstrap_min_css.html">bootstrap.min.css</a>
  
    <li><a href="../../public/stylesheets/custom2_css.html">custom2.css</a>
  
    <li><a href="../../public/stylesheets/le-frog/jquery-ui-1_8_16_custom_css.html">jquery-ui-1.8.16.custom.css</a>
  
    <li><a href="../../public/stylesheets/menu_css.html">menu.css</a>
  
    <li><a href="../../public/stylesheets/reset_css.html">reset.css</a>
  
    <li><a href="../../public/stylesheets/scaffold_css.html">scaffold.css</a>
  
    <li><a href="../../public/stylesheets/tms_css.html">tms.css</a>
  
    <li><a href="../../public/stylesheets/ui-darkness/jquery-ui-1_8_16_custom_css.html">jquery-ui-1.8.16.custom.css</a>
  
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-label="Page public/javascripts/prototype.js">

<pre>  Prototype JavaScript framework, version 1.7_rc2
  (c) 2005-2010 Sam Stephenson

  Prototype is freely distributable under the terms of an MIT-style license.
  For details, see the Prototype web site: http://www.prototypejs.org/

--------------------------------------------------------------------------</pre>

<p>var Prototype = {</p>

<pre>Version: &#39;1.7_rc2&#39;,

Browser: (function(){
  var ua = navigator.userAgent;
  var isOpera = Object.prototype.toString.call(window.opera) == &#39;[object Opera]&#39;;
  return {
    IE:             !!window.attachEvent &amp;&amp; !isOpera,
    Opera:          isOpera,
    WebKit:         ua.indexOf(&#39;AppleWebKit/&#39;) &gt; -1,
    Gecko:          ua.indexOf(&#39;Gecko&#39;) &gt; -1 &amp;&amp; ua.indexOf(&#39;KHTML&#39;) === -1,
    MobileSafari:   /Apple.*Mobile/.test(ua)
  }
})(),

BrowserFeatures: {
  XPath: !!document.evaluate,

  SelectorsAPI: !!document.querySelector,

  ElementExtensions: (function() {
    var constructor = window.Element || window.HTMLElement;
    return !!(constructor &amp;&amp; constructor.prototype);
  })(),
  SpecificElementExtensions: (function() {
    if (typeof window.HTMLDivElement !== &#39;undefined&#39;)
      return true;

    var div = document.createElement(&#39;div&#39;),
        form = document.createElement(&#39;form&#39;),
        isSupported = false;

    if (div[&#39;__proto__&#39;] &amp;&amp; (div[&#39;__proto__&#39;] !== form[&#39;__proto__&#39;])) {
      isSupported = true;
    }

    div = form = null;

    return isSupported;
  })()
},

ScriptFragment: &#39;&lt;script[^&gt;]*&gt;([\\S\\s]*?)&lt;\/script&gt;&#39;,
JSONFilter: /^\/\*-secure-([\s\S]*)\*\/\s*$/,

emptyFunction: function() { },

K: function(x) { return x }</pre>

<p>};</p>

<p>if (Prototype.Browser.MobileSafari)</p>

<pre class="ruby"><span class="ruby-constant">Prototype</span>.<span class="ruby-constant">BrowserFeatures</span>.<span class="ruby-constant">SpecificElementExtensions</span> = <span class="ruby-keyword">false</span>;
</pre>

<p>var Abstract = { };</p>

<p>var Try = {</p>

<pre>these: function() {
  var returnValue;

  for (var i = 0, length = arguments.length; i &lt; length; i++) {
    var lambda = arguments[i];
    try {
      returnValue = lambda();
      break;
    } catch (e) { }
  }

  return returnValue;
}</pre>

<p>};</p>

<pre>Based on Alex Arnell&#39;s inheritance implementation.</pre>

<p>var Class = (function() {</p>

<pre>var IS_DONTENUM_BUGGY = (function(){
  for (var p in { toString: 1 }) {
    if (p === &#39;toString&#39;) return false;
  }
  return true;
})();

function subclass() {};
function create() {
  var parent = null, properties = $A(arguments);
  if (Object.isFunction(properties[0]))
    parent = properties.shift();

  function klass() {
    this.initialize.apply(this, arguments);
  }

  Object.extend(klass, Class.Methods);
  klass.superclass = parent;
  klass.subclasses = [];

  if (parent) {
    subclass.prototype = parent.prototype;
    klass.prototype = new subclass;
    parent.subclasses.push(klass);
  }

  for (var i = 0, length = properties.length; i &lt; length; i++)
    klass.addMethods(properties[i]);

  if (!klass.prototype.initialize)
    klass.prototype.initialize = Prototype.emptyFunction;

  klass.prototype.constructor = klass;
  return klass;
}

function addMethods(source) {
  var ancestor   = this.superclass &amp;&amp; this.superclass.prototype,
      properties = Object.keys(source);

  if (IS_DONTENUM_BUGGY) {
    if (source.toString != Object.prototype.toString)
      properties.push(&quot;toString&quot;);
    if (source.valueOf != Object.prototype.valueOf)
      properties.push(&quot;valueOf&quot;);
  }

  for (var i = 0, length = properties.length; i &lt; length; i++) {
    var property = properties[i], value = source[property];
    if (ancestor &amp;&amp; Object.isFunction(value) &amp;&amp;
        value.argumentNames()[0] == &quot;$super&quot;) {
      var method = value;
      value = (function(m) {
        return function() { return ancestor[m].apply(this, arguments); };
      })(property).wrap(method);

      value.valueOf = method.valueOf.bind(method);
      value.toString = method.toString.bind(method);
    }
    this.prototype[property] = value;
  }

  return this;
}

return {
  create: create,
  Methods: {
    addMethods: addMethods
  }
};</pre>

<p>})(); (function() {</p>

<pre>var _toString = Object.prototype.toString,
    NULL_TYPE = &#39;Null&#39;,
    UNDEFINED_TYPE = &#39;Undefined&#39;,
    BOOLEAN_TYPE = &#39;Boolean&#39;,
    NUMBER_TYPE = &#39;Number&#39;,
    STRING_TYPE = &#39;String&#39;,
    OBJECT_TYPE = &#39;Object&#39;,
    BOOLEAN_CLASS = &#39;[object Boolean]&#39;,
    NUMBER_CLASS = &#39;[object Number]&#39;,
    STRING_CLASS = &#39;[object String]&#39;,
    ARRAY_CLASS = &#39;[object Array]&#39;,
    NATIVE_JSON_STRINGIFY_SUPPORT = window.JSON &amp;&amp;
      typeof JSON.stringify === &#39;function&#39; &amp;&amp;
      JSON.stringify(0) === &#39;0&#39; &amp;&amp;
      typeof JSON.stringify(Prototype.K) === &#39;undefined&#39;;

function Type(o) {
  switch(o) {
    case null: return NULL_TYPE;
    case (void 0): return UNDEFINED_TYPE;
  }
  var type = typeof o;
  switch(type) {
    case &#39;boolean&#39;: return BOOLEAN_TYPE;
    case &#39;number&#39;:  return NUMBER_TYPE;
    case &#39;string&#39;:  return STRING_TYPE;
  }
  return OBJECT_TYPE;
}

function extend(destination, source) {
  for (var property in source)
    destination[property] = source[property];
  return destination;
}

function inspect(object) {
  try {
    if (isUndefined(object)) return &#39;undefined&#39;;
    if (object === null) return &#39;null&#39;;
    return object.inspect ? object.inspect() : String(object);
  } catch (e) {
    if (e instanceof RangeError) return &#39;...&#39;;
    throw e;
  }
}

function toJSON(value) {
  return Str(&#39;&#39;, { &#39;&#39;: value }, []);
}

function Str(key, holder, stack) {
  var value = holder[key],
      type = typeof value;

  if (Type(value) === OBJECT_TYPE &amp;&amp; typeof value.toJSON === &#39;function&#39;) {
    value = value.toJSON(key);
  }

  var _class = _toString.call(value);

  switch (_class) {
    case NUMBER_CLASS:
    case BOOLEAN_CLASS:
    case STRING_CLASS:
      value = value.valueOf();
  }

  switch (value) {
    case null: return &#39;null&#39;;
    case true: return &#39;true&#39;;
    case false: return &#39;false&#39;;
  }

  type = typeof value;
  switch (type) {
    case &#39;string&#39;:
      return value.inspect(true);
    case &#39;number&#39;:
      return isFinite(value) ? String(value) : &#39;null&#39;;
    case &#39;object&#39;:

      for (var i = 0, length = stack.length; i &lt; length; i++) {
        if (stack[i] === value) { throw new TypeError(); }
      }
      stack.push(value);

      var partial = [];
      if (_class === ARRAY_CLASS) {
        for (var i = 0, length = value.length; i &lt; length; i++) {
          var str = Str(i, value, stack);
          partial.push(typeof str === &#39;undefined&#39; ? &#39;null&#39; : str);
        }
        partial = &#39;[&#39; + partial.join(&#39;,&#39;) + &#39;]&#39;;
      } else {
        var keys = Object.keys(value);
        for (var i = 0, length = keys.length; i &lt; length; i++) {
          var key = keys[i], str = Str(key, value, stack);
          if (typeof str !== &quot;undefined&quot;) {
             partial.push(key.inspect(true)+ &#39;:&#39; + str);
           }
        }
        partial = &#39;{&#39; + partial.join(&#39;,&#39;) + &#39;}&#39;;
      }
      stack.pop();
      return partial;
  }
}

function stringify(object) {
  return JSON.stringify(object);
}

function toQueryString(object) {
  return $H(object).toQueryString();
}

function toHTML(object) {
  return object &amp;&amp; object.toHTML ? object.toHTML() : String.interpret(object);
}

function keys(object) {
  if (Type(object) !== OBJECT_TYPE) { throw new TypeError(); }
  var results = [];
  for (var property in object) {
    if (object.hasOwnProperty(property)) {
      results.push(property);
    }
  }
  return results;
}

function values(object) {
  var results = [];
  for (var property in object)
    results.push(object[property]);
  return results;
}

function clone(object) {
  return extend({ }, object);
}

function isElement(object) {
  return !!(object &amp;&amp; object.nodeType == 1);
}

function isArray(object) {
  return _toString.call(object) === ARRAY_CLASS;
}

var hasNativeIsArray = (typeof Array.isArray == &#39;function&#39;)
  &amp;&amp; Array.isArray([]) &amp;&amp; !Array.isArray({});

if (hasNativeIsArray) {
  isArray = Array.isArray;
}

function isHash(object) {
  return object instanceof Hash;
}

function isFunction(object) {
  return typeof object === &quot;function&quot;;
}

function isString(object) {
  return _toString.call(object) === STRING_CLASS;
}

function isNumber(object) {
  return _toString.call(object) === NUMBER_CLASS;
}

function isUndefined(object) {
  return typeof object === &quot;undefined&quot;;
}

extend(Object, {
  extend:        extend,
  inspect:       inspect,
  toJSON:        NATIVE_JSON_STRINGIFY_SUPPORT ? stringify : toJSON,
  toQueryString: toQueryString,
  toHTML:        toHTML,
  keys:          Object.keys || keys,
  values:        values,
  clone:         clone,
  isElement:     isElement,
  isArray:       isArray,
  isHash:        isHash,
  isFunction:    isFunction,
  isString:      isString,
  isNumber:      isNumber,
  isUndefined:   isUndefined
});</pre>

<p>})(); Object.extend(Function.prototype, (function() {</p>

<pre>var slice = Array.prototype.slice;

function update(array, args) {
  var arrayLength = array.length, length = args.length;
  while (length--) array[arrayLength + length] = args[length];
  return array;
}

function merge(array, args) {
  array = slice.call(array, 0);
  return update(array, args);
}

function argumentNames() {
  var names = this.toString().match(/^[\s\(]*function[^(]*\(([^)]*)\)/)[1]
    .replace(/\/\/.*?[\r\n]|\/\*(?:.|[\r\n])*?\*\//g, &#39;&#39;)
    .replace(/\s+/g, &#39;&#39;).split(&#39;,&#39;);
  return names.length == 1 &amp;&amp; !names[0] ? [] : names;
}

function bind(context) {
  if (arguments.length &lt; 2 &amp;&amp; Object.isUndefined(arguments[0])) return this;
  var __method = this, args = slice.call(arguments, 1);
  return function() {
    var a = merge(args, arguments);
    return __method.apply(context, a);
  }
}

function bindAsEventListener(context) {
  var __method = this, args = slice.call(arguments, 1);
  return function(event) {
    var a = update([event || window.event], args);
    return __method.apply(context, a);
  }
}

function curry() {
  if (!arguments.length) return this;
  var __method = this, args = slice.call(arguments, 0);
  return function() {
    var a = merge(args, arguments);
    return __method.apply(this, a);
  }
}

function delay(timeout) {
  var __method = this, args = slice.call(arguments, 1);
  timeout = timeout * 1000;
  return window.setTimeout(function() {
    return __method.apply(__method, args);
  }, timeout);
}

function defer() {
  var args = update([0.01], arguments);
  return this.delay.apply(this, args);
}

function wrap(wrapper) {
  var __method = this;
  return function() {
    var a = update([__method.bind(this)], arguments);
    return wrapper.apply(this, a);
  }
}

function methodize() {
  if (this._methodized) return this._methodized;
  var __method = this;
  return this._methodized = function() {
    var a = update([this], arguments);
    return __method.apply(null, a);
  };
}

return {
  argumentNames:       argumentNames,
  bind:                bind,
  bindAsEventListener: bindAsEventListener,
  curry:               curry,
  delay:               delay,
  defer:               defer,
  wrap:                wrap,
  methodize:           methodize
}</pre>

<p>})());</p>

<p>(function(proto) {</p>

<pre>function toISOString() {
  return this.getUTCFullYear() + &#39;-&#39; +
    (this.getUTCMonth() + 1).toPaddedString(2) + &#39;-&#39; +
    this.getUTCDate().toPaddedString(2) + &#39;T&#39; +
    this.getUTCHours().toPaddedString(2) + &#39;:&#39; +
    this.getUTCMinutes().toPaddedString(2) + &#39;:&#39; +
    this.getUTCSeconds().toPaddedString(2) + &#39;Z&#39;;
}

function toJSON() {
  return this.toISOString();
}

if (!proto.toISOString) proto.toISOString = toISOString;
if (!proto.toJSON) proto.toJSON = toJSON;</pre>

<p>})(Date.prototype);</p>

<p>RegExp.prototype.match = RegExp.prototype.test;</p>

<p>RegExp.escape = function(str) {</p>

<pre>return String(str).replace(/([.*+?^=!:${}()|[\]\/\\])/g, &#39;\\$1&#39;);</pre>

<p>}; var PeriodicalExecuter = Class.create({</p>

<pre>initialize: function(callback, frequency) {
  this.callback = callback;
  this.frequency = frequency;
  this.currentlyExecuting = false;

  this.registerCallback();
},

registerCallback: function() {
  this.timer = setInterval(this.onTimerEvent.bind(this), this.frequency * 1000);
},

execute: function() {
  this.callback(this);
},

stop: function() {
  if (!this.timer) return;
  clearInterval(this.timer);
  this.timer = null;
},

onTimerEvent: function() {
  if (!this.currentlyExecuting) {
    try {
      this.currentlyExecuting = true;
      this.execute();
      this.currentlyExecuting = false;
    } catch(e) {
      this.currentlyExecuting = false;
      throw e;
    }
  }
}</pre>

<p>}); Object.extend(String, {</p>

<pre>interpret: function(value) {
  return value == null ? &#39;&#39; : String(value);
},
specialChar: {
  &#39;\b&#39;: &#39;\\b&#39;,
  &#39;\t&#39;: &#39;\\t&#39;,
  &#39;\n&#39;: &#39;\\n&#39;,
  &#39;\f&#39;: &#39;\\f&#39;,
  &#39;\r&#39;: &#39;\\r&#39;,
  &#39;\\&#39;: &#39;\\\\&#39;
}</pre>

<p>});</p>

<p>Object.extend(String.prototype, (function() {</p>

<pre>var NATIVE_JSON_PARSE_SUPPORT = window.JSON &amp;&amp;
  typeof JSON.parse === &#39;function&#39; &amp;&amp;
  JSON.parse(&#39;{&quot;test&quot;: true}&#39;).test;

function prepareReplacement(replacement) {
  if (Object.isFunction(replacement)) return replacement;
  var template = new Template(replacement);
  return function(match) { return template.evaluate(match) };
}

function gsub(pattern, replacement) {
  var result = &#39;&#39;, source = this, match;
  replacement = prepareReplacement(replacement);

  if (Object.isString(pattern))
    pattern = RegExp.escape(pattern);

  if (!(pattern.length || pattern.source)) {
    replacement = replacement(&#39;&#39;);
    return replacement + source.split(&#39;&#39;).join(replacement) + replacement;
  }

  while (source.length &gt; 0) {
    if (match = source.match(pattern)) {
      result += source.slice(0, match.index);
      result += String.interpret(replacement(match));
      source  = source.slice(match.index + match[0].length);
    } else {
      result += source, source = &#39;&#39;;
    }
  }
  return result;
}

function sub(pattern, replacement, count) {
  replacement = prepareReplacement(replacement);
  count = Object.isUndefined(count) ? 1 : count;

  return this.gsub(pattern, function(match) {
    if (--count &lt; 0) return match[0];
    return replacement(match);
  });
}

function scan(pattern, iterator) {
  this.gsub(pattern, iterator);
  return String(this);
}

function truncate(length, truncation) {
  length = length || 30;
  truncation = Object.isUndefined(truncation) ? &#39;...&#39; : truncation;
  return this.length &gt; length ?
    this.slice(0, length - truncation.length) + truncation : String(this);
}

function strip() {
  return this.replace(/^\s+/, &#39;&#39;).replace(/\s+$/, &#39;&#39;);
}

function stripTags() {
  return this.replace(/&lt;\w+(\s+(&quot;[^&quot;]*&quot;|&#39;[^&#39;]*&#39;|[^&gt;])+)?&gt;|&lt;\/\w+&gt;/gi, &#39;&#39;);
}

function stripScripts() {
  return this.replace(new RegExp(Prototype.ScriptFragment, &#39;img&#39;), &#39;&#39;);
}

function extractScripts() {
  var matchAll = new RegExp(Prototype.ScriptFragment, &#39;img&#39;),
      matchOne = new RegExp(Prototype.ScriptFragment, &#39;im&#39;);
  return (this.match(matchAll) || []).map(function(scriptTag) {
    return (scriptTag.match(matchOne) || [&#39;&#39;, &#39;&#39;])[1];
  });
}

function evalScripts() {
  return this.extractScripts().map(function(script) { return eval(script) });
}

function escapeHTML() {
  return this.replace(/&amp;/g,&#39;&amp;amp;&#39;).replace(/&lt;/g,&#39;&amp;lt;&#39;).replace(/&gt;/g,&#39;&amp;gt;&#39;);
}

function unescapeHTML() {
  return this.stripTags().replace(/&amp;lt;/g,&#39;&lt;&#39;).replace(/&amp;gt;/g,&#39;&gt;&#39;).replace(/&amp;amp;/g,&#39;&amp;&#39;);
}

function toQueryParams(separator) {
  var match = this.strip().match(/([^?#]*)(#.*)?$/);
  if (!match) return { };

  return match[1].split(separator || &#39;&amp;&#39;).inject({ }, function(hash, pair) {
    if ((pair = pair.split(&#39;=&#39;))[0]) {
      var key = decodeURIComponent(pair.shift()),
          value = pair.length &gt; 1 ? pair.join(&#39;=&#39;) : pair[0];

      if (value != undefined) value = decodeURIComponent(value);

      if (key in hash) {
        if (!Object.isArray(hash[key])) hash[key] = [hash[key]];
        hash[key].push(value);
      }
      else hash[key] = value;
    }
    return hash;
  });
}

function toArray() {
  return this.split(&#39;&#39;);
}

function succ() {
  return this.slice(0, this.length - 1) +
    String.fromCharCode(this.charCodeAt(this.length - 1) + 1);
}

function times(count) {
  return count &lt; 1 ? &#39;&#39; : new Array(count + 1).join(this);
}

function camelize() {
  return this.replace(/-+(.)?/g, function(match, chr) {
    return chr ? chr.toUpperCase() : &#39;&#39;;
  });
}

function capitalize() {
  return this.charAt(0).toUpperCase() + this.substring(1).toLowerCase();
}

function underscore() {
  return this.replace(/::/g, &#39;/&#39;)
             .replace(/([A-Z]+)([A-Z][a-z])/g, &#39;$1_$2&#39;)
             .replace(/([a-z\d])([A-Z])/g, &#39;$1_$2&#39;)
             .replace(/-/g, &#39;_&#39;)
             .toLowerCase();
}

function dasherize() {
  return this.replace(/_/g, &#39;-&#39;);
}

function inspect(useDoubleQuotes) {
  var escapedString = this.replace(/[\x00-\x1f\\]/g, function(character) {
    if (character in String.specialChar) {
      return String.specialChar[character];
    }
    return &#39;\\u00&#39; + character.charCodeAt().toPaddedString(2, 16);
  });
  if (useDoubleQuotes) return &#39;&quot;&#39; + escapedString.replace(/&quot;/g, &#39;\\&quot;&#39;) + &#39;&quot;&#39;;
  return &quot;&#39;&quot; + escapedString.replace(/&#39;/g, &#39;\\\&#39;&#39;) + &quot;&#39;&quot;;
}

function unfilterJSON(filter) {
  return this.replace(filter || Prototype.JSONFilter, &#39;$1&#39;);
}

function isJSON() {
  var str = this;
  if (str.blank()) return false;
  str = str.replace(/\\(?:[&quot;\\\/bfnrt]|u[0-9a-fA-F]{4})/g, &#39;@&#39;);
  str = str.replace(/&quot;[^&quot;\\\n\r]*&quot;|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g, &#39;]&#39;);
  str = str.replace(/(?:^|:|,)(?:\s*\[)+/g, &#39;&#39;);
  return (/^[\],:{}\s]*$/).test(str);
}

function evalJSON(sanitize) {
  var json = this.unfilterJSON(),
      cx = /[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g;
  if (cx.test(json)) {
    json = json.replace(cx, function (a) {
      return &#39;\\u&#39; + (&#39;0000&#39; + a.charCodeAt(0).toString(16)).slice(-4);
    });
  }
  try {
    if (!sanitize || json.isJSON()) return eval(&#39;(&#39; + json + &#39;)&#39;);
  } catch (e) { }
  throw new SyntaxError(&#39;Badly formed JSON string: &#39; + this.inspect());
}

function parseJSON() {
  var json = this.unfilterJSON();
  return JSON.parse(json);
}

function include(pattern) {
  return this.indexOf(pattern) &gt; -1;
}

function startsWith(pattern) {
  return this.lastIndexOf(pattern, 0) === 0;
}

function endsWith(pattern) {
  var d = this.length - pattern.length;
  return d &gt;= 0 &amp;&amp; this.indexOf(pattern, d) === d;
}

function empty() {
  return this == &#39;&#39;;
}

function blank() {
  return /^\s*$/.test(this);
}

function interpolate(object, pattern) {
  return new Template(this, pattern).evaluate(object);
}

return {
  gsub:           gsub,
  sub:            sub,
  scan:           scan,
  truncate:       truncate,
  strip:          String.prototype.trim || strip,
  stripTags:      stripTags,
  stripScripts:   stripScripts,
  extractScripts: extractScripts,
  evalScripts:    evalScripts,
  escapeHTML:     escapeHTML,
  unescapeHTML:   unescapeHTML,
  toQueryParams:  toQueryParams,
  parseQuery:     toQueryParams,
  toArray:        toArray,
  succ:           succ,
  times:          times,
  camelize:       camelize,
  capitalize:     capitalize,
  underscore:     underscore,
  dasherize:      dasherize,
  inspect:        inspect,
  unfilterJSON:   unfilterJSON,
  isJSON:         isJSON,
  evalJSON:       NATIVE_JSON_PARSE_SUPPORT ? parseJSON : evalJSON,
  include:        include,
  startsWith:     startsWith,
  endsWith:       endsWith,
  empty:          empty,
  blank:          blank,
  interpolate:    interpolate
};</pre>

<p>})());</p>

<p>var Template = Class.create({</p>

<pre>initialize: function(template, pattern) {
  this.template = template.toString();
  this.pattern = pattern || Template.Pattern;
},

evaluate: function(object) {
  if (object &amp;&amp; Object.isFunction(object.toTemplateReplacements))
    object = object.toTemplateReplacements();

  return this.template.gsub(this.pattern, function(match) {
    if (object == null) return (match[1] + &#39;&#39;);

    var before = match[1] || &#39;&#39;;
    if (before == &#39;\\&#39;) return match[2];

    var ctx = object, expr = match[3],
        pattern = /^([^.[]+|\[((?:.*?[^\\])?)\])(\.|\[|$)/;

    match = pattern.exec(expr);
    if (match == null) return before;

    while (match != null) {
      var comp = match[1].startsWith(&#39;[&#39;) ? match[2].replace(/\\\\]/g, &#39;]&#39;) : match[1];
      ctx = ctx[comp];
      if (null == ctx || &#39;&#39; == match[3]) break;
      expr = expr.substring(&#39;[&#39; == match[3] ? match[1].length : match[0].length);
      match = pattern.exec(expr);
    }

    return before + String.interpret(ctx);
  });
}</pre>

<p>}); Template.Pattern = /(^|.|r|n)(#{(.*?)})/;</p>

<p>var $break = { };</p>

<p>var Enumerable = (function() {</p>

<pre>function each(iterator, context) {
  var index = 0;
  try {
    this._each(function(value) {
      iterator.call(context, value, index++);
    });
  } catch (e) {
    if (e != $break) throw e;
  }
  return this;
}

function eachSlice(number, iterator, context) {
  var index = -number, slices = [], array = this.toArray();
  if (number &lt; 1) return array;
  while ((index += number) &lt; array.length)
    slices.push(array.slice(index, index+number));
  return slices.collect(iterator, context);
}

function all(iterator, context) {
  iterator = iterator || Prototype.K;
  var result = true;
  this.each(function(value, index) {
    result = result &amp;&amp; !!iterator.call(context, value, index);
    if (!result) throw $break;
  });
  return result;
}

function any(iterator, context) {
  iterator = iterator || Prototype.K;
  var result = false;
  this.each(function(value, index) {
    if (result = !!iterator.call(context, value, index))
      throw $break;
  });
  return result;
}

function collect(iterator, context) {
  iterator = iterator || Prototype.K;
  var results = [];
  this.each(function(value, index) {
    results.push(iterator.call(context, value, index));
  });
  return results;
}

function detect(iterator, context) {
  var result;
  this.each(function(value, index) {
    if (iterator.call(context, value, index)) {
      result = value;
      throw $break;
    }
  });
  return result;
}

function findAll(iterator, context) {
  var results = [];
  this.each(function(value, index) {
    if (iterator.call(context, value, index))
      results.push(value);
  });
  return results;
}

function grep(filter, iterator, context) {
  iterator = iterator || Prototype.K;
  var results = [];

  if (Object.isString(filter))
    filter = new RegExp(RegExp.escape(filter));

  this.each(function(value, index) {
    if (filter.match(value))
      results.push(iterator.call(context, value, index));
  });
  return results;
}

function include(object) {
  if (Object.isFunction(this.indexOf))
    if (this.indexOf(object) != -1) return true;

  var found = false;
  this.each(function(value) {
    if (value == object) {
      found = true;
      throw $break;
    }
  });
  return found;
}

function inGroupsOf(number, fillWith) {
  fillWith = Object.isUndefined(fillWith) ? null : fillWith;
  return this.eachSlice(number, function(slice) {
    while(slice.length &lt; number) slice.push(fillWith);
    return slice;
  });
}

function inject(memo, iterator, context) {
  this.each(function(value, index) {
    memo = iterator.call(context, memo, value, index);
  });
  return memo;
}

function invoke(method) {
  var args = $A(arguments).slice(1);
  return this.map(function(value) {
    return value[method].apply(value, args);
  });
}

function max(iterator, context) {
  iterator = iterator || Prototype.K;
  var result;
  this.each(function(value, index) {
    value = iterator.call(context, value, index);
    if (result == null || value &gt;= result)
      result = value;
  });
  return result;
}

function min(iterator, context) {
  iterator = iterator || Prototype.K;
  var result;
  this.each(function(value, index) {
    value = iterator.call(context, value, index);
    if (result == null || value &lt; result)
      result = value;
  });
  return result;
}

function partition(iterator, context) {
  iterator = iterator || Prototype.K;
  var trues = [], falses = [];
  this.each(function(value, index) {
    (iterator.call(context, value, index) ?
      trues : falses).push(value);
  });
  return [trues, falses];
}

function pluck(property) {
  var results = [];
  this.each(function(value) {
    results.push(value[property]);
  });
  return results;
}

function reject(iterator, context) {
  var results = [];
  this.each(function(value, index) {
    if (!iterator.call(context, value, index))
      results.push(value);
  });
  return results;
}

function sortBy(iterator, context) {
  return this.map(function(value, index) {
    return {
      value: value,
      criteria: iterator.call(context, value, index)
    };
  }).sort(function(left, right) {
    var a = left.criteria, b = right.criteria;
    return a &lt; b ? -1 : a &gt; b ? 1 : 0;
  }).pluck(&#39;value&#39;);
}

function toArray() {
  return this.map();
}

function zip() {
  var iterator = Prototype.K, args = $A(arguments);
  if (Object.isFunction(args.last()))
    iterator = args.pop();

  var collections = [this].concat(args).map($A);
  return this.map(function(value, index) {
    return iterator(collections.pluck(index));
  });
}

function size() {
  return this.toArray().length;
}

function inspect() {
  return &#39;#&lt;Enumerable:&#39; + this.toArray().inspect() + &#39;&gt;&#39;;
}

return {
  each:       each,
  eachSlice:  eachSlice,
  all:        all,
  every:      all,
  any:        any,
  some:       any,
  collect:    collect,
  map:        collect,
  detect:     detect,
  findAll:    findAll,
  select:     findAll,
  filter:     findAll,
  grep:       grep,
  include:    include,
  member:     include,
  inGroupsOf: inGroupsOf,
  inject:     inject,
  invoke:     invoke,
  max:        max,
  min:        min,
  partition:  partition,
  pluck:      pluck,
  reject:     reject,
  sortBy:     sortBy,
  toArray:    toArray,
  entries:    toArray,
  zip:        zip,
  size:       size,
  inspect:    inspect,
  find:       detect
};</pre>

<p>})();</p>

<p>function $A(iterable) {</p>

<pre>if (!iterable) return [];
if (&#39;toArray&#39; in Object(iterable)) return iterable.toArray();
var length = iterable.length || 0, results = new Array(length);
while (length--) results[length] = iterable[length];
return results;</pre>

<p>}</p>

<p>function $w(string) {</p>

<pre>if (!Object.isString(string)) return [];
string = string.strip();
return string ? string.split(/\s+/) : [];</pre>

<p>}</p>

<p>Array.from = $A;</p>

<p>(function() {</p>

<pre>var arrayProto = Array.prototype,
    slice = arrayProto.slice,
    _each = arrayProto.forEach; // use native browser JS 1.6 implementation if available

function each(iterator) {
  for (var i = 0, length = this.length; i &lt; length; i++)
    iterator(this[i]);
}
if (!_each) _each = each;

function clear() {
  this.length = 0;
  return this;
}

function first() {
  return this[0];
}

function last() {
  return this[this.length - 1];
}

function compact() {
  return this.select(function(value) {
    return value != null;
  });
}

function flatten() {
  return this.inject([], function(array, value) {
    if (Object.isArray(value))
      return array.concat(value.flatten());
    array.push(value);
    return array;
  });
}

function without() {
  var values = slice.call(arguments, 0);
  return this.select(function(value) {
    return !values.include(value);
  });
}

function reverse(inline) {
  return (inline === false ? this.toArray() : this)._reverse();
}

function uniq(sorted) {
  return this.inject([], function(array, value, index) {
    if (0 == index || (sorted ? array.last() != value : !array.include(value)))
      array.push(value);
    return array;
  });
}

function intersect(array) {
  return this.uniq().findAll(function(item) {
    return array.detect(function(value) { return item === value });
  });
}

function clone() {
  return slice.call(this, 0);
}

function size() {
  return this.length;
}

function inspect() {
  return &#39;[&#39; + this.map(Object.inspect).join(&#39;, &#39;) + &#39;]&#39;;
}

function indexOf(item, i) {
  i || (i = 0);
  var length = this.length;
  if (i &lt; 0) i = length + i;
  for (; i &lt; length; i++)
    if (this[i] === item) return i;
  return -1;
}

function lastIndexOf(item, i) {
  i = isNaN(i) ? this.length : (i &lt; 0 ? this.length + i : i) + 1;
  var n = this.slice(0, i).reverse().indexOf(item);
  return (n &lt; 0) ? n : i - n - 1;
}

function concat() {
  var array = slice.call(this, 0), item;
  for (var i = 0, length = arguments.length; i &lt; length; i++) {
    item = arguments[i];
    if (Object.isArray(item) &amp;&amp; !(&#39;callee&#39; in item)) {
      for (var j = 0, arrayLength = item.length; j &lt; arrayLength; j++)
        array.push(item[j]);
    } else {
      array.push(item);
    }
  }
  return array;
}

Object.extend(arrayProto, Enumerable);

if (!arrayProto._reverse)
  arrayProto._reverse = arrayProto.reverse;

Object.extend(arrayProto, {
  _each:     _each,
  clear:     clear,
  first:     first,
  last:      last,
  compact:   compact,
  flatten:   flatten,
  without:   without,
  reverse:   reverse,
  uniq:      uniq,
  intersect: intersect,
  clone:     clone,
  toArray:   clone,
  size:      size,
  inspect:   inspect
});

var CONCAT_ARGUMENTS_BUGGY = (function() {
  return [].concat(arguments)[0][0] !== 1;
})(1,2)

if (CONCAT_ARGUMENTS_BUGGY) arrayProto.concat = concat;

if (!arrayProto.indexOf) arrayProto.indexOf = indexOf;
if (!arrayProto.lastIndexOf) arrayProto.lastIndexOf = lastIndexOf;</pre>

<p>})(); function $H(object) {</p>

<pre class="ruby"><span class="ruby-keyword">return</span> <span class="ruby-identifier">new</span> <span class="ruby-constant">Hash</span>(<span class="ruby-identifier">object</span>);
</pre>

<p>};</p>

<p>var Hash = Class.create(Enumerable, (function() {</p>

<pre>function initialize(object) {
  this._object = Object.isHash(object) ? object.toObject() : Object.clone(object);
}

function _each(iterator) {
  for (var key in this._object) {
    var value = this._object[key], pair = [key, value];
    pair.key = key;
    pair.value = value;
    iterator(pair);
  }
}

function set(key, value) {
  return this._object[key] = value;
}

function get(key) {
  if (this._object[key] !== Object.prototype[key])
    return this._object[key];
}

function unset(key) {
  var value = this._object[key];
  delete this._object[key];
  return value;
}

function toObject() {
  return Object.clone(this._object);
}

function keys() {
  return this.pluck(&#39;key&#39;);
}

function values() {
  return this.pluck(&#39;value&#39;);
}

function index(value) {
  var match = this.detect(function(pair) {
    return pair.value === value;
  });
  return match &amp;&amp; match.key;
}

function merge(object) {
  return this.clone().update(object);
}

function update(object) {
  return new Hash(object).inject(this, function(result, pair) {
    result.set(pair.key, pair.value);
    return result;
  });
}

function toQueryPair(key, value) {
  if (Object.isUndefined(value)) return key;
  return key + &#39;=&#39; + encodeURIComponent(String.interpret(value));
}

function toQueryString() {
  return this.inject([], function(results, pair) {
    var key = encodeURIComponent(pair.key), values = pair.value;

    if (values &amp;&amp; typeof values == &#39;object&#39;) {
      if (Object.isArray(values))
        return results.concat(values.map(toQueryPair.curry(key)));
    } else results.push(toQueryPair(key, values));
    return results;
  }).join(&#39;&amp;&#39;);
}

function inspect() {
  return &#39;#&lt;Hash:{&#39; + this.map(function(pair) {
    return pair.map(Object.inspect).join(&#39;: &#39;);
  }).join(&#39;, &#39;) + &#39;}&gt;&#39;;
}

function clone() {
  return new Hash(this);
}

return {
  initialize:             initialize,
  _each:                  _each,
  set:                    set,
  get:                    get,
  unset:                  unset,
  toObject:               toObject,
  toTemplateReplacements: toObject,
  keys:                   keys,
  values:                 values,
  index:                  index,
  merge:                  merge,
  update:                 update,
  toQueryString:          toQueryString,
  inspect:                inspect,
  toJSON:                 toObject,
  clone:                  clone
};</pre>

<p>})());</p>

<p>Hash.from = $H; Object.extend(Number.prototype, (function() {</p>

<pre>function toColorPart() {
  return this.toPaddedString(2, 16);
}

function succ() {
  return this + 1;
}

function times(iterator, context) {
  $R(0, this, true).each(iterator, context);
  return this;
}

function toPaddedString(length, radix) {
  var string = this.toString(radix || 10);
  return &#39;0&#39;.times(length - string.length) + string;
}

function abs() {
  return Math.abs(this);
}

function round() {
  return Math.round(this);
}

function ceil() {
  return Math.ceil(this);
}

function floor() {
  return Math.floor(this);
}

return {
  toColorPart:    toColorPart,
  succ:           succ,
  times:          times,
  toPaddedString: toPaddedString,
  abs:            abs,
  round:          round,
  ceil:           ceil,
  floor:          floor
};</pre>

<p>})());</p>

<p>function $R(start, end, exclusive) {</p>

<pre>return new ObjectRange(start, end, exclusive);</pre>

<p>}</p>

<p>var ObjectRange = Class.create(Enumerable, (function() {</p>

<pre>function initialize(start, end, exclusive) {
  this.start = start;
  this.end = end;
  this.exclusive = exclusive;
}

function _each(iterator) {
  var value = this.start;
  while (this.include(value)) {
    iterator(value);
    value = value.succ();
  }
}

function include(value) {
  if (value &lt; this.start)
    return false;
  if (this.exclusive)
    return value &lt; this.end;
  return value &lt;= this.end;
}

return {
  initialize: initialize,
  _each:      _each,
  include:    include
};</pre>

<p>})());</p>

<p>var Ajax = {</p>

<pre>getTransport: function() {
  return Try.these(
    function() {return new XMLHttpRequest()},
    function() {return new ActiveXObject(&#39;Msxml2.XMLHTTP&#39;)},
    function() {return new ActiveXObject(&#39;Microsoft.XMLHTTP&#39;)}
  ) || false;
},

activeRequestCount: 0</pre>

<p>};</p>

<p>Ajax.Responders = {</p>

<pre>responders: [],

_each: function(iterator) {
  this.responders._each(iterator);
},

register: function(responder) {
  if (!this.include(responder))
    this.responders.push(responder);
},

unregister: function(responder) {
  this.responders = this.responders.without(responder);
},

dispatch: function(callback, request, transport, json) {
  this.each(function(responder) {
    if (Object.isFunction(responder[callback])) {
      try {
        responder[callback].apply(responder, [request, transport, json]);
      } catch (e) { }
    }
  });
}</pre>

<p>};</p>

<p>Object.extend(Ajax.Responders, Enumerable);</p>

<p>Ajax.Responders.register({</p>

<pre>onCreate:   function() { Ajax.activeRequestCount++ },
onComplete: function() { Ajax.activeRequestCount-- }</pre>

<p>}); Ajax.Base = Class.create({</p>

<pre>initialize: function(options) {
  this.options = {
    method:       &#39;post&#39;,
    asynchronous: true,
    contentType:  &#39;application/x-www-form-urlencoded&#39;,
    encoding:     &#39;UTF-8&#39;,
    parameters:   &#39;&#39;,
    evalJSON:     true,
    evalJS:       true
  };
  Object.extend(this.options, options || { });

  this.options.method = this.options.method.toLowerCase();

  if (Object.isString(this.options.parameters))
    this.options.parameters = this.options.parameters.toQueryParams();
  else if (Object.isHash(this.options.parameters))
    this.options.parameters = this.options.parameters.toObject();
}</pre>

<p>}); Ajax.Request = Class.create(Ajax.Base, {</p>

<pre>_complete: false,

initialize: function($super, url, options) {
  $super(options);
  this.transport = Ajax.getTransport();
  this.request(url);
},

request: function(url) {
  this.url = url;
  this.method = this.options.method;
  var params = Object.clone(this.options.parameters);

  if (![&#39;get&#39;, &#39;post&#39;].include(this.method)) {
    params[&#39;_method&#39;] = this.method;
    this.method = &#39;post&#39;;
  }

  this.parameters = params;

  if (params = Object.toQueryString(params)) {
    if (this.method == &#39;get&#39;)
      this.url += (this.url.include(&#39;?&#39;) ? &#39;&amp;&#39; : &#39;?&#39;) + params;
    else if (/Konqueror|Safari|KHTML/.test(navigator.userAgent))
      params += &#39;&amp;_=&#39;;
  }

  try {
    var response = new Ajax.Response(this);
    if (this.options.onCreate) this.options.onCreate(response);
    Ajax.Responders.dispatch(&#39;onCreate&#39;, this, response);

    this.transport.open(this.method.toUpperCase(), this.url,
      this.options.asynchronous);

    if (this.options.asynchronous) this.respondToReadyState.bind(this).defer(1);

    this.transport.onreadystatechange = this.onStateChange.bind(this);
    this.setRequestHeaders();

    this.body = this.method == &#39;post&#39; ? (this.options.postBody || params) : null;
    this.transport.send(this.body);

    /* Force Firefox to handle ready state 4 for synchronous requests */
    if (!this.options.asynchronous &amp;&amp; this.transport.overrideMimeType)
      this.onStateChange();

  }
  catch (e) {
    this.dispatchException(e);
  }
},

onStateChange: function() {
  var readyState = this.transport.readyState;
  if (readyState &gt; 1 &amp;&amp; !((readyState == 4) &amp;&amp; this._complete))
    this.respondToReadyState(this.transport.readyState);
},

setRequestHeaders: function() {
  var headers = {
    &#39;X-Requested-With&#39;: &#39;XMLHttpRequest&#39;,
    &#39;X-Prototype-Version&#39;: Prototype.Version,
    &#39;Accept&#39;: &#39;text/javascript, text/html, application/xml, text/xml, */*&#39;
  };

  if (this.method == &#39;post&#39;) {
    headers[&#39;Content-type&#39;] = this.options.contentType +
      (this.options.encoding ? &#39;; charset=&#39; + this.options.encoding : &#39;&#39;);

    /* Force &quot;Connection: close&quot; for older Mozilla browsers to work
       around a bug where XMLHttpRequest sends an incorrect
       Content-length header. See Mozilla Bugzilla #246651.
      /
    if (this.transport.overrideMimeType &amp;&amp;
        (navigator.userAgent.match(/Gecko\/(\d{4})/) || [0,2005])[1] &lt; 2005)
          headers[&#39;Connection&#39;] = &#39;close&#39;;
  }

  if (typeof this.options.requestHeaders == &#39;object&#39;) {
    var extras = this.options.requestHeaders;

    if (Object.isFunction(extras.push))
      for (var i = 0, length = extras.length; i &lt; length; i += 2)
        headers[extras[i]] = extras[i+1];
    else
      $H(extras).each(function(pair) { headers[pair.key] = pair.value });
  }

  for (var name in headers)
    this.transport.setRequestHeader(name, headers[name]);
},

success: function() {
  var status = this.getStatus();
  return !status || (status &gt;= 200 &amp;&amp; status &lt; 300);
},

getStatus: function() {
  try {
    return this.transport.status || 0;
  } catch (e) { return 0 }
},

respondToReadyState: function(readyState) {
  var state = Ajax.Request.Events[readyState], response = new Ajax.Response(this);

  if (state == &#39;Complete&#39;) {
    try {
      this._complete = true;
      (this.options[&#39;on&#39; + response.status]
       || this.options[&#39;on&#39; + (this.success() ? &#39;Success&#39; : &#39;Failure&#39;)]
       || Prototype.emptyFunction)(response, response.headerJSON);
    } catch (e) {
      this.dispatchException(e);
    }

    var contentType = response.getHeader(&#39;Content-type&#39;);
    if (this.options.evalJS == &#39;force&#39;
        || (this.options.evalJS &amp;&amp; this.isSameOrigin() &amp;&amp; contentType
        &amp;&amp; contentType.match(/^\s*(text|application)\/(x-)?(java|ecma)script(;.*)?\s*$/i)))
      this.evalResponse();
  }

  try {
    (this.options[&#39;on&#39; + state] || Prototype.emptyFunction)(response, response.headerJSON);
    Ajax.Responders.dispatch(&#39;on&#39; + state, this, response, response.headerJSON);
  } catch (e) {
    this.dispatchException(e);
  }

  if (state == &#39;Complete&#39;) {
    this.transport.onreadystatechange = Prototype.emptyFunction;
  }
},

isSameOrigin: function() {
  var m = this.url.match(/^\s*https?:\/\/[^\/]*/);
  return !m || (m[0] == &#39;#{protocol}//#{domain}#{port}&#39;.interpolate({
    protocol: location.protocol,
    domain: document.domain,
    port: location.port ? &#39;:&#39; + location.port : &#39;&#39;
  }));
},

getHeader: function(name) {
  try {
    return this.transport.getResponseHeader(name) || null;
  } catch (e) { return null; }
},

evalResponse: function() {
  try {
    return eval((this.transport.responseText || &#39;&#39;).unfilterJSON());
  } catch (e) {
    this.dispatchException(e);
  }
},

dispatchException: function(exception) {
  (this.options.onException || Prototype.emptyFunction)(this, exception);
  Ajax.Responders.dispatch(&#39;onException&#39;, this, exception);
}</pre>

<p>});</p>

<p>Ajax.Request.Events =</p>

<pre class="ruby">[<span class="ruby-string">&#39;Uninitialized&#39;</span>, <span class="ruby-string">&#39;Loading&#39;</span>, <span class="ruby-string">&#39;Loaded&#39;</span>, <span class="ruby-string">&#39;Interactive&#39;</span>, <span class="ruby-string">&#39;Complete&#39;</span>];
</pre>

<p>Ajax.Response = Class.create({</p>

<pre>initialize: function(request){
  this.request = request;
  var transport  = this.transport  = request.transport,
      readyState = this.readyState = transport.readyState;

  if ((readyState &gt; 2 &amp;&amp; !Prototype.Browser.IE) || readyState == 4) {
    this.status       = this.getStatus();
    this.statusText   = this.getStatusText();
    this.responseText = String.interpret(transport.responseText);
    this.headerJSON   = this._getHeaderJSON();
  }

  if (readyState == 4) {
    var xml = transport.responseXML;
    this.responseXML  = Object.isUndefined(xml) ? null : xml;
    this.responseJSON = this._getResponseJSON();
  }
},

status:      0,

statusText: &#39;&#39;,

getStatus: Ajax.Request.prototype.getStatus,

getStatusText: function() {
  try {
    return this.transport.statusText || &#39;&#39;;
  } catch (e) { return &#39;&#39; }
},

getHeader: Ajax.Request.prototype.getHeader,

getAllHeaders: function() {
  try {
    return this.getAllResponseHeaders();
  } catch (e) { return null }
},

getResponseHeader: function(name) {
  return this.transport.getResponseHeader(name);
},

getAllResponseHeaders: function() {
  return this.transport.getAllResponseHeaders();
},

_getHeaderJSON: function() {
  var json = this.getHeader(&#39;X-JSON&#39;);
  if (!json) return null;
  json = decodeURIComponent(escape(json));
  try {
    return json.evalJSON(this.request.options.sanitizeJSON ||
      !this.request.isSameOrigin());
  } catch (e) {
    this.request.dispatchException(e);
  }
},

_getResponseJSON: function() {
  var options = this.request.options;
  if (!options.evalJSON || (options.evalJSON != &#39;force&#39; &amp;&amp;
    !(this.getHeader(&#39;Content-type&#39;) || &#39;&#39;).include(&#39;application/json&#39;)) ||
      this.responseText.blank())
        return null;
  try {
    return this.responseText.evalJSON(options.sanitizeJSON ||
      !this.request.isSameOrigin());
  } catch (e) {
    this.request.dispatchException(e);
  }
}</pre>

<p>});</p>

<p>Ajax.Updater = Class.create(Ajax.Request, {</p>

<pre>initialize: function($super, container, url, options) {
  this.container = {
    success: (container.success || container),
    failure: (container.failure || (container.success ? null : container))
  };

  options = Object.clone(options);
  var onComplete = options.onComplete;
  options.onComplete = (function(response, json) {
    this.updateContent(response.responseText);
    if (Object.isFunction(onComplete)) onComplete(response, json);
  }).bind(this);

  $super(url, options);
},

updateContent: function(responseText) {
  var receiver = this.container[this.success() ? &#39;success&#39; : &#39;failure&#39;],
      options = this.options;

  if (!options.evalScripts) responseText = responseText.stripScripts();

  if (receiver = $(receiver)) {
    if (options.insertion) {
      if (Object.isString(options.insertion)) {
        var insertion = { }; insertion[options.insertion] = responseText;
        receiver.insert(insertion);
      }
      else options.insertion(receiver, responseText);
    }
    else receiver.update(responseText);
  }
}</pre>

<p>});</p>

<p>Ajax.PeriodicalUpdater = Class.create(Ajax.Base, {</p>

<pre>initialize: function($super, container, url, options) {
  $super(options);
  this.onComplete = this.options.onComplete;

  this.frequency = (this.options.frequency || 2);
  this.decay = (this.options.decay || 1);

  this.updater = { };
  this.container = container;
  this.url = url;

  this.start();
},

start: function() {
  this.options.onComplete = this.updateComplete.bind(this);
  this.onTimerEvent();
},

stop: function() {
  this.updater.options.onComplete = undefined;
  clearTimeout(this.timer);
  (this.onComplete || Prototype.emptyFunction).apply(this, arguments);
},

updateComplete: function(response) {
  if (this.options.decay) {
    this.decay = (response.responseText == this.lastText ?
      this.decay * this.options.decay : 1);

    this.lastText = response.responseText;
  }
  this.timer = this.onTimerEvent.bind(this).delay(this.decay * this.frequency);
},

onTimerEvent: function() {
  this.updater = new Ajax.Updater(this.container, this.url, this.options);
}</pre>

<p>});</p>

<p>function $(element) {</p>

<pre>if (arguments.length &gt; 1) {
  for (var i = 0, elements = [], length = arguments.length; i &lt; length; i++)
    elements.push($(arguments[i]));
  return elements;
}
if (Object.isString(element))
  element = document.getElementById(element);
return Element.extend(element);</pre>

<p>}</p>

<p>if (Prototype.BrowserFeatures.XPath) {</p>

<pre>document._getElementsByXPath = function(expression, parentElement) {
  var results = [];
  var query = document.evaluate(expression, $(parentElement) || document,
    null, XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
  for (var i = 0, length = query.snapshotLength; i &lt; length; i++)
    results.push(Element.extend(query.snapshotItem(i)));
  return results;
};</pre>

<p>}</p>

<p>/<strong>————————————————————————–</strong>/</p>

<p>if (!Node) var Node = { };</p>

<p>if (!Node.ELEMENT_NODE) {</p>

<pre class="ruby"><span class="ruby-constant">Object</span>.<span class="ruby-identifier">extend</span>(<span class="ruby-constant">Node</span>, {
  <span class="ruby-constant">ELEMENT_NODE</span><span class="ruby-operator">:</span> <span class="ruby-value">1</span>,
  <span class="ruby-constant">ATTRIBUTE_NODE</span><span class="ruby-operator">:</span> <span class="ruby-value">2</span>,
  <span class="ruby-constant">TEXT_NODE</span><span class="ruby-operator">:</span> <span class="ruby-value">3</span>,
  <span class="ruby-constant">CDATA_SECTION_NODE</span><span class="ruby-operator">:</span> <span class="ruby-value">4</span>,
  <span class="ruby-constant">ENTITY_REFERENCE_NODE</span><span class="ruby-operator">:</span> <span class="ruby-value">5</span>,
  <span class="ruby-constant">ENTITY_NODE</span><span class="ruby-operator">:</span> <span class="ruby-value">6</span>,
  <span class="ruby-constant">PROCESSING_INSTRUCTION_NODE</span><span class="ruby-operator">:</span> <span class="ruby-value">7</span>,
  <span class="ruby-constant">COMMENT_NODE</span><span class="ruby-operator">:</span> <span class="ruby-value">8</span>,
  <span class="ruby-constant">DOCUMENT_NODE</span><span class="ruby-operator">:</span> <span class="ruby-value">9</span>,
  <span class="ruby-constant">DOCUMENT_TYPE_NODE</span><span class="ruby-operator">:</span> <span class="ruby-value">10</span>,
  <span class="ruby-constant">DOCUMENT_FRAGMENT_NODE</span><span class="ruby-operator">:</span> <span class="ruby-value">11</span>,
  <span class="ruby-constant">NOTATION_NODE</span><span class="ruby-operator">:</span> <span class="ruby-value">12</span>
});
</pre>

<p>}</p>

<p>(function(global) {</p>

<pre>var HAS_EXTENDED_CREATE_ELEMENT_SYNTAX = (function(){
  try {
    var el = document.createElement(&#39;&lt;input name=&quot;x&quot;&gt;&#39;);
    return el.tagName.toLowerCase() === &#39;input&#39; &amp;&amp; el.name === &#39;x&#39;;
  }
  catch(err) {
    return false;
  }
})();

var element = global.Element;

global.Element = function(tagName, attributes) {
  attributes = attributes || { };
  tagName = tagName.toLowerCase();
  var cache = Element.cache;
  if (HAS_EXTENDED_CREATE_ELEMENT_SYNTAX &amp;&amp; attributes.name) {
    tagName = &#39;&lt;&#39; + tagName + &#39; name=&quot;&#39; + attributes.name + &#39;&quot;&gt;&#39;;
    delete attributes.name;
    return Element.writeAttribute(document.createElement(tagName), attributes);
  }
  if (!cache[tagName]) cache[tagName] = Element.extend(document.createElement(tagName));
  return Element.writeAttribute(cache[tagName].cloneNode(false), attributes);
};

Object.extend(global.Element, element || { });
if (element) global.Element.prototype = element.prototype;</pre>

<p>})(this);</p>

<p>Element.idCounter = 1; Element.cache = { };</p>

<p>function purgeElement(element) {</p>

<pre>var uid = element._prototypeUID;
if (uid) {
  Element.stopObserving(element);
  element._prototypeUID = void 0;
  delete Element.Storage[uid];
}</pre>

<p>}</p>

<p>Element.Methods = {</p>

<pre>visible: function(element) {
  return $(element).style.display != &#39;none&#39;;
},

toggle: function(element) {
  element = $(element);
  Element[Element.visible(element) ? &#39;hide&#39; : &#39;show&#39;](element);
  return element;
},

hide: function(element) {
  element = $(element);
  element.style.display = &#39;none&#39;;
  return element;
},

show: function(element) {
  element = $(element);
  element.style.display = &#39;&#39;;
  return element;
},

remove: function(element) {
  element = $(element);
  element.parentNode.removeChild(element);
  return element;
},

update: (function(){

  var SELECT_ELEMENT_INNERHTML_BUGGY = (function(){
    var el = document.createElement(&quot;select&quot;),
        isBuggy = true;
    el.innerHTML = &quot;&lt;option value=\&quot;test\&quot;&gt;test&lt;/option&gt;&quot;;
    if (el.options &amp;&amp; el.options[0]) {
      isBuggy = el.options[0].nodeName.toUpperCase() !== &quot;OPTION&quot;;
    }
    el = null;
    return isBuggy;
  })();

  var TABLE_ELEMENT_INNERHTML_BUGGY = (function(){
    try {
      var el = document.createElement(&quot;table&quot;);
      if (el &amp;&amp; el.tBodies) {
        el.innerHTML = &quot;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;test&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&quot;;
        var isBuggy = typeof el.tBodies[0] == &quot;undefined&quot;;
        el = null;
        return isBuggy;
      }
    } catch (e) {
      return true;
    }
  })();

  var SCRIPT_ELEMENT_REJECTS_TEXTNODE_APPENDING = (function () {
    var s = document.createElement(&quot;script&quot;),
        isBuggy = false;
    try {
      s.appendChild(document.createTextNode(&quot;&quot;));
      isBuggy = !s.firstChild ||
        s.firstChild &amp;&amp; s.firstChild.nodeType !== 3;
    } catch (e) {
      isBuggy = true;
    }
    s = null;
    return isBuggy;
  })();

  function update(element, content) {
    element = $(element);

    var descendants = element.getElementsByTagName(&#39;*&#39;),
     i = descendants.length;
    while (i--) purgeElement(descendants[i]);

    if (content &amp;&amp; content.toElement)
      content = content.toElement();

    if (Object.isElement(content))
      return element.update().insert(content);

    content = Object.toHTML(content);

    var tagName = element.tagName.toUpperCase();

    if (tagName === &#39;SCRIPT&#39; &amp;&amp; SCRIPT_ELEMENT_REJECTS_TEXTNODE_APPENDING) {
      element.text = content;
      return element;
    }

    if (SELECT_ELEMENT_INNERHTML_BUGGY || TABLE_ELEMENT_INNERHTML_BUGGY) {
      if (tagName in Element._insertionTranslations.tags) {
        while (element.firstChild) {
          element.removeChild(element.firstChild);
        }
        Element._getContentFromAnonymousElement(tagName, content.stripScripts())
          .each(function(node) {
            element.appendChild(node)
          });
      }
      else {
        element.innerHTML = content.stripScripts();
      }
    }
    else {
      element.innerHTML = content.stripScripts();
    }

    content.evalScripts.bind(content).defer();
    return element;
  }

  return update;
})(),

replace: function(element, content) {
  element = $(element);
  if (content &amp;&amp; content.toElement) content = content.toElement();
  else if (!Object.isElement(content)) {
    content = Object.toHTML(content);
    var range = element.ownerDocument.createRange();
    range.selectNode(element);
    content.evalScripts.bind(content).defer();
    content = range.createContextualFragment(content.stripScripts());
  }
  element.parentNode.replaceChild(content, element);
  return element;
},

insert: function(element, insertions) {
  element = $(element);

  if (Object.isString(insertions) || Object.isNumber(insertions) ||
      Object.isElement(insertions) || (insertions &amp;&amp; (insertions.toElement || insertions.toHTML)))
        insertions = {bottom:insertions};

  var content, insert, tagName, childNodes;

  for (var position in insertions) {
    content  = insertions[position];
    position = position.toLowerCase();
    insert = Element._insertionTranslations[position];

    if (content &amp;&amp; content.toElement) content = content.toElement();
    if (Object.isElement(content)) {
      insert(element, content);
      continue;
    }

    content = Object.toHTML(content);

    tagName = ((position == &#39;before&#39; || position == &#39;after&#39;)
      ? element.parentNode : element).tagName.toUpperCase();

    childNodes = Element._getContentFromAnonymousElement(tagName, content.stripScripts());

    if (position == &#39;top&#39; || position == &#39;after&#39;) childNodes.reverse();
    childNodes.each(insert.curry(element));

    content.evalScripts.bind(content).defer();
  }

  return element;
},

wrap: function(element, wrapper, attributes) {
  element = $(element);
  if (Object.isElement(wrapper))
    $(wrapper).writeAttribute(attributes || { });
  else if (Object.isString(wrapper)) wrapper = new Element(wrapper, attributes);
  else wrapper = new Element(&#39;div&#39;, wrapper);
  if (element.parentNode)
    element.parentNode.replaceChild(wrapper, element);
  wrapper.appendChild(element);
  return wrapper;
},

inspect: function(element) {
  element = $(element);
  var result = &#39;&lt;&#39; + element.tagName.toLowerCase();
  $H({&#39;id&#39;: &#39;id&#39;, &#39;className&#39;: &#39;class&#39;}).each(function(pair) {
    var property = pair.first(),
        attribute = pair.last(),
        value = (element[property] || &#39;&#39;).toString();
    if (value) result += &#39; &#39; + attribute + &#39;=&#39; + value.inspect(true);
  });
  return result + &#39;&gt;&#39;;
},

recursivelyCollect: function(element, property, maximumLength) {
  element = $(element);
  maximumLength = maximumLength || -1;
  var elements = [];

  while (element = element[property]) {
    if (element.nodeType == 1)
      elements.push(Element.extend(element));
    if (elements.length == maximumLength)
      break;
  }

  return elements;
},

ancestors: function(element) {
  return Element.recursivelyCollect(element, &#39;parentNode&#39;);
},

descendants: function(element) {
  return Element.select(element, &quot;*&quot;);
},

firstDescendant: function(element) {
  element = $(element).firstChild;
  while (element &amp;&amp; element.nodeType != 1) element = element.nextSibling;
  return $(element);
},

immediateDescendants: function(element) {
  var results = [], child = $(element).firstChild;
  while (child) {
    if (child.nodeType === 1) {
      results.push(Element.extend(child));
    }
    child = child.nextSibling;
  }
  return results;
},

previousSiblings: function(element, maximumLength) {
  return Element.recursivelyCollect(element, &#39;previousSibling&#39;);
},

nextSiblings: function(element) {
  return Element.recursivelyCollect(element, &#39;nextSibling&#39;);
},

siblings: function(element) {
  element = $(element);
  return Element.previousSiblings(element).reverse()
    .concat(Element.nextSiblings(element));
},

match: function(element, selector) {
  element = $(element);
  if (Object.isString(selector))
    return Prototype.Selector.match(element, selector);
  return selector.match(element);
},

up: function(element, expression, index) {
  element = $(element);
  if (arguments.length == 1) return $(element.parentNode);
  var ancestors = Element.ancestors(element);
  return Object.isNumber(expression) ? ancestors[expression] :
    Prototype.Selector.find(ancestors, expression, index);
},

down: function(element, expression, index) {
  element = $(element);
  if (arguments.length == 1) return Element.firstDescendant(element);
  return Object.isNumber(expression) ? Element.descendants(element)[expression] :
    Element.select(element, expression)[index || 0];
},

previous: function(element, expression, index) {
  element = $(element);
  if (Object.isNumber(expression)) index = expression, expression = false;
  if (!Object.isNumber(index)) index = 0;

  if (expression) {
    return Prototype.Selector.find(element.previousSiblings(), expression, index);
  } else {
    return element.recursivelyCollect(&quot;previousSibling&quot;, index + 1)[index];
  }
},

next: function(element, expression, index) {
  element = $(element);
  if (Object.isNumber(expression)) index = expression, expression = false;
  if (!Object.isNumber(index)) index = 0;

  if (expression) {
    return Prototype.Selector.find(element.nextSiblings(), expression, index);
  } else {
    var maximumLength = Object.isNumber(index) ? index + 1 : 1;
    return element.recursivelyCollect(&quot;nextSibling&quot;, index + 1)[index];
  }
},

select: function(element) {
  element = $(element);
  var expressions = Array.prototype.slice.call(arguments, 1).join(&#39;, &#39;);
  return Prototype.Selector.select(expressions, element);
},

adjacent: function(element) {
  element = $(element);
  var expressions = Array.prototype.slice.call(arguments, 1).join(&#39;, &#39;);
  return Prototype.Selector.select(expressions, element.parentNode).without(element);
},

identify: function(element) {
  element = $(element);
  var id = Element.readAttribute(element, &#39;id&#39;);
  if (id) return id;
  do { id = &#39;anonymous_element_&#39; + Element.idCounter++ } while ($(id));
  Element.writeAttribute(element, &#39;id&#39;, id);
  return id;
},

readAttribute: function(element, name) {
  element = $(element);
  if (Prototype.Browser.IE) {
    var t = Element._attributeTranslations.read;
    if (t.values[name]) return t.values[name](element, name);
    if (t.names[name]) name = t.names[name];
    if (name.include(&#39;:&#39;)) {
      return (!element.attributes || !element.attributes[name]) ? null :
       element.attributes[name].value;
    }
  }
  return element.getAttribute(name);
},

writeAttribute: function(element, name, value) {
  element = $(element);
  var attributes = { }, t = Element._attributeTranslations.write;

  if (typeof name == &#39;object&#39;) attributes = name;
  else attributes[name] = Object.isUndefined(value) ? true : value;

  for (var attr in attributes) {
    name = t.names[attr] || attr;
    value = attributes[attr];
    if (t.values[attr]) name = t.values[attr](element, value);
    if (value === false || value === null)
      element.removeAttribute(name);
    else if (value === true)
      element.setAttribute(name, name);
    else element.setAttribute(name, value);
  }
  return element;
},

getHeight: function(element) {
  return Element.getDimensions(element).height;
},

getWidth: function(element) {
  return Element.getDimensions(element).width;
},

classNames: function(element) {
  return new Element.ClassNames(element);
},

hasClassName: function(element, className) {
  if (!(element = $(element))) return;
  var elementClassName = element.className;
  return (elementClassName.length &gt; 0 &amp;&amp; (elementClassName == className ||
    new RegExp(&quot;(^|\\s)&quot; + className + &quot;(\\s|$)&quot;).test(elementClassName)));
},

addClassName: function(element, className) {
  if (!(element = $(element))) return;
  if (!Element.hasClassName(element, className))
    element.className += (element.className ? &#39; &#39; : &#39;&#39;) + className;
  return element;
},

removeClassName: function(element, className) {
  if (!(element = $(element))) return;
  element.className = element.className.replace(
    new RegExp(&quot;(^|\\s+)&quot; + className + &quot;(\\s+|$)&quot;), &#39; &#39;).strip();
  return element;
},

toggleClassName: function(element, className) {
  if (!(element = $(element))) return;
  return Element[Element.hasClassName(element, className) ?
    &#39;removeClassName&#39; : &#39;addClassName&#39;](element, className);
},

cleanWhitespace: function(element) {
  element = $(element);
  var node = element.firstChild;
  while (node) {
    var nextNode = node.nextSibling;
    if (node.nodeType == 3 &amp;&amp; !/\S/.test(node.nodeValue))
      element.removeChild(node);
    node = nextNode;
  }
  return element;
},

empty: function(element) {
  return $(element).innerHTML.blank();
},

descendantOf: function(element, ancestor) {
  element = $(element), ancestor = $(ancestor);

  if (element.compareDocumentPosition)
    return (element.compareDocumentPosition(ancestor) &amp; 8) === 8;

  if (ancestor.contains)
    return ancestor.contains(element) &amp;&amp; ancestor !== element;

  while (element = element.parentNode)
    if (element == ancestor) return true;

  return false;
},

scrollTo: function(element) {
  element = $(element);
  var pos = Element.cumulativeOffset(element);
  window.scrollTo(pos[0], pos[1]);
  return element;
},

getStyle: function(element, style) {
  element = $(element);
  style = style == &#39;float&#39; ? &#39;cssFloat&#39; : style.camelize();
  var value = element.style[style];
  if (!value || value == &#39;auto&#39;) {
    var css = document.defaultView.getComputedStyle(element, null);
    value = css ? css[style] : null;
  }
  if (style == &#39;opacity&#39;) return value ? parseFloat(value) : 1.0;
  return value == &#39;auto&#39; ? null : value;
},

getOpacity: function(element) {
  return $(element).getStyle(&#39;opacity&#39;);
},

setStyle: function(element, styles) {
  element = $(element);
  var elementStyle = element.style, match;
  if (Object.isString(styles)) {
    element.style.cssText += &#39;;&#39; + styles;
    return styles.include(&#39;opacity&#39;) ?
      element.setOpacity(styles.match(/opacity:\s*(\d?\.?\d*)/)[1]) : element;
  }
  for (var property in styles)
    if (property == &#39;opacity&#39;) element.setOpacity(styles[property]);
    else
      elementStyle[(property == &#39;float&#39; || property == &#39;cssFloat&#39;) ?
        (Object.isUndefined(elementStyle.styleFloat) ? &#39;cssFloat&#39; : &#39;styleFloat&#39;) :
          property] = styles[property];

  return element;
},

setOpacity: function(element, value) {
  element = $(element);
  element.style.opacity = (value == 1 || value === &#39;&#39;) ? &#39;&#39; :
    (value &lt; 0.00001) ? 0 : value;
  return element;
},

makePositioned: function(element) {
  element = $(element);
  var pos = Element.getStyle(element, &#39;position&#39;);
  if (pos == &#39;static&#39; || !pos) {
    element._madePositioned = true;
    element.style.position = &#39;relative&#39;;
    if (Prototype.Browser.Opera) {
      element.style.top = 0;
      element.style.left = 0;
    }
  }
  return element;
},

undoPositioned: function(element) {
  element = $(element);
  if (element._madePositioned) {
    element._madePositioned = undefined;
    element.style.position =
      element.style.top =
      element.style.left =
      element.style.bottom =
      element.style.right = &#39;&#39;;
  }
  return element;
},

makeClipping: function(element) {
  element = $(element);
  if (element._overflow) return element;
  element._overflow = Element.getStyle(element, &#39;overflow&#39;) || &#39;auto&#39;;
  if (element._overflow !== &#39;hidden&#39;)
    element.style.overflow = &#39;hidden&#39;;
  return element;
},

undoClipping: function(element) {
  element = $(element);
  if (!element._overflow) return element;
  element.style.overflow = element._overflow == &#39;auto&#39; ? &#39;&#39; : element._overflow;
  element._overflow = null;
  return element;
},

cumulativeOffset: function(element) {
  var valueT = 0, valueL = 0;
  if (element.parentNode) {
    do {
      valueT += element.offsetTop  || 0;
      valueL += element.offsetLeft || 0;
      element = element.offsetParent;
    } while (element);
  }
  return Element._returnOffset(valueL, valueT);
},

positionedOffset: function(element) {
  var valueT = 0, valueL = 0;
  do {
    valueT += element.offsetTop  || 0;
    valueL += element.offsetLeft || 0;
    element = element.offsetParent;
    if (element) {
      if (element.tagName.toUpperCase() == &#39;BODY&#39;) break;
      var p = Element.getStyle(element, &#39;position&#39;);
      if (p !== &#39;static&#39;) break;
    }
  } while (element);
  return Element._returnOffset(valueL, valueT);
},

absolutize: function(element) {
  element = $(element);
  if (Element.getStyle(element, &#39;position&#39;) == &#39;absolute&#39;) return element;

  var offsets = Element.positionedOffset(element),
      top     = offsets[1],
      left    = offsets[0],
      width   = element.clientWidth,
      height  = element.clientHeight;

  element._originalLeft   = left - parseFloat(element.style.left  || 0);
  element._originalTop    = top  - parseFloat(element.style.top || 0);
  element._originalWidth  = element.style.width;
  element._originalHeight = element.style.height;

  element.style.position = &#39;absolute&#39;;
  element.style.top    = top + &#39;px&#39;;
  element.style.left   = left + &#39;px&#39;;
  element.style.width  = width + &#39;px&#39;;
  element.style.height = height + &#39;px&#39;;
  return element;
},

relativize: function(element) {
  element = $(element);
  if (Element.getStyle(element, &#39;position&#39;) == &#39;relative&#39;) return element;

  element.style.position = &#39;relative&#39;;
  var top  = parseFloat(element.style.top  || 0) - (element._originalTop || 0),
      left = parseFloat(element.style.left || 0) - (element._originalLeft || 0);

  element.style.top    = top + &#39;px&#39;;
  element.style.left   = left + &#39;px&#39;;
  element.style.height = element._originalHeight;
  element.style.width  = element._originalWidth;
  return element;
},

cumulativeScrollOffset: function(element) {
  var valueT = 0, valueL = 0;
  do {
    valueT += element.scrollTop  || 0;
    valueL += element.scrollLeft || 0;
    element = element.parentNode;
  } while (element);
  return Element._returnOffset(valueL, valueT);
},

getOffsetParent: function(element) {
  if (element.offsetParent) return $(element.offsetParent);
  if (element == document.body) return $(element);

  while ((element = element.parentNode) &amp;&amp; element != document.body)
    if (Element.getStyle(element, &#39;position&#39;) != &#39;static&#39;)
      return $(element);

  return $(document.body);
},

viewportOffset: function(forElement) {
  var valueT = 0,
      valueL = 0,
      element = forElement;

  do {
    valueT += element.offsetTop  || 0;
    valueL += element.offsetLeft || 0;

    if (element.offsetParent == document.body &amp;&amp;
      Element.getStyle(element, &#39;position&#39;) == &#39;absolute&#39;) break;

  } while (element = element.offsetParent);

  element = forElement;
  do {
    if (!Prototype.Browser.Opera || (element.tagName &amp;&amp; (element.tagName.toUpperCase() == &#39;BODY&#39;))) {
      valueT -= element.scrollTop  || 0;
      valueL -= element.scrollLeft || 0;
    }
  } while (element = element.parentNode);

  return Element._returnOffset(valueL, valueT);
},

clonePosition: function(element, source) {
  var options = Object.extend({
    setLeft:    true,
    setTop:     true,
    setWidth:   true,
    setHeight:  true,
    offsetTop:  0,
    offsetLeft: 0
  }, arguments[2] || { });

  source = $(source);
  var p = Element.viewportOffset(source), delta = [0, 0], parent = null;

  element = $(element);

  if (Element.getStyle(element, &#39;position&#39;) == &#39;absolute&#39;) {
    parent = Element.getOffsetParent(element);
    delta = Element.viewportOffset(parent);
  }

  if (parent == document.body) {
    delta[0] -= document.body.offsetLeft;
    delta[1] -= document.body.offsetTop;
  }

  if (options.setLeft)   element.style.left  = (p[0] - delta[0] + options.offsetLeft) + &#39;px&#39;;
  if (options.setTop)    element.style.top   = (p[1] - delta[1] + options.offsetTop) + &#39;px&#39;;
  if (options.setWidth)  element.style.width = source.offsetWidth + &#39;px&#39;;
  if (options.setHeight) element.style.height = source.offsetHeight + &#39;px&#39;;
  return element;
}</pre>

<p>};</p>

<p>Object.extend(Element.Methods, {</p>

<pre>getElementsBySelector: Element.Methods.select,

childElements: Element.Methods.immediateDescendants</pre>

<p>});</p>

<p>Element._attributeTranslations = {</p>

<pre>write: {
  names: {
    className: &#39;class&#39;,
    htmlFor:   &#39;for&#39;
  },
  values: { }
}</pre>

<p>};</p>

<p>if (Prototype.Browser.Opera) {</p>

<pre>Element.Methods.getStyle = Element.Methods.getStyle.wrap(
  function(proceed, element, style) {
    switch (style) {
      case &#39;left&#39;: case &#39;top&#39;: case &#39;right&#39;: case &#39;bottom&#39;:
        if (proceed(element, &#39;position&#39;) === &#39;static&#39;) return null;
      case &#39;height&#39;: case &#39;width&#39;:
        if (!Element.visible(element)) return null;

        var dim = parseInt(proceed(element, style), 10);

        if (dim !== element[&#39;offset&#39; + style.capitalize()])
          return dim + &#39;px&#39;;

        var properties;
        if (style === &#39;height&#39;) {
          properties = [&#39;border-top-width&#39;, &#39;padding-top&#39;,
           &#39;padding-bottom&#39;, &#39;border-bottom-width&#39;];
        }
        else {
          properties = [&#39;border-left-width&#39;, &#39;padding-left&#39;,
           &#39;padding-right&#39;, &#39;border-right-width&#39;];
        }
        return properties.inject(dim, function(memo, property) {
          var val = proceed(element, property);
          return val === null ? memo : memo - parseInt(val, 10);
        }) + &#39;px&#39;;
      default: return proceed(element, style);
    }
  }
);

Element.Methods.readAttribute = Element.Methods.readAttribute.wrap(
  function(proceed, element, attribute) {
    if (attribute === &#39;title&#39;) return element.title;
    return proceed(element, attribute);
  }
);</pre>

<p>}</p>

<p>else if (Prototype.Browser.IE) {</p>

<pre>Element.Methods.getOffsetParent = Element.Methods.getOffsetParent.wrap(
  function(proceed, element) {
    element = $(element);
    if (!element.parentNode) return $(document.body);
    var position = element.getStyle(&#39;position&#39;);
    if (position !== &#39;static&#39;) return proceed(element);
    element.setStyle({ position: &#39;relative&#39; });
    var value = proceed(element);
    element.setStyle({ position: position });
    return value;
  }
);

$w(&#39;positionedOffset viewportOffset&#39;).each(function(method) {
  Element.Methods[method] = Element.Methods[method].wrap(
    function(proceed, element) {
      element = $(element);
      if (!element.parentNode) return Element._returnOffset(0, 0);
      var position = element.getStyle(&#39;position&#39;);
      if (position !== &#39;static&#39;) return proceed(element);
      var offsetParent = element.getOffsetParent();
      if (offsetParent &amp;&amp; offsetParent.getStyle(&#39;position&#39;) === &#39;fixed&#39;)
        offsetParent.setStyle({ zoom: 1 });
      element.setStyle({ position: &#39;relative&#39; });
      var value = proceed(element);
      element.setStyle({ position: position });
      return value;
    }
  );
});

Element.Methods.getStyle = function(element, style) {
  element = $(element);
  style = (style == &#39;float&#39; || style == &#39;cssFloat&#39;) ? &#39;styleFloat&#39; : style.camelize();
  var value = element.style[style];
  if (!value &amp;&amp; element.currentStyle) value = element.currentStyle[style];

  if (style == &#39;opacity&#39;) {
    if (value = (element.getStyle(&#39;filter&#39;) || &#39;&#39;).match(/alpha\(opacity=(.*)\)/))
      if (value[1]) return parseFloat(value[1]) / 100;
    return 1.0;
  }

  if (value == &#39;auto&#39;) {
    if ((style == &#39;width&#39; || style == &#39;height&#39;) &amp;&amp; (element.getStyle(&#39;display&#39;) != &#39;none&#39;))
      return element[&#39;offset&#39; + style.capitalize()] + &#39;px&#39;;
    return null;
  }
  return value;
};

Element.Methods.setOpacity = function(element, value) {
  function stripAlpha(filter){
    return filter.replace(/alpha\([^\)]*\)/gi,&#39;&#39;);
  }
  element = $(element);
  var currentStyle = element.currentStyle;
  if ((currentStyle &amp;&amp; !currentStyle.hasLayout) ||
    (!currentStyle &amp;&amp; element.style.zoom == &#39;normal&#39;))
      element.style.zoom = 1;

  var filter = element.getStyle(&#39;filter&#39;), style = element.style;
  if (value == 1 || value === &#39;&#39;) {
    (filter = stripAlpha(filter)) ?
      style.filter = filter : style.removeAttribute(&#39;filter&#39;);
    return element;
  } else if (value &lt; 0.00001) value = 0;
  style.filter = stripAlpha(filter) +
    &#39;alpha(opacity=&#39; + (value * 100) + &#39;)&#39;;
  return element;
};

Element._attributeTranslations = (function(){

  var classProp = &#39;className&#39;,
      forProp = &#39;for&#39;,
      el = document.createElement(&#39;div&#39;);

  el.setAttribute(classProp, &#39;x&#39;);

  if (el.className !== &#39;x&#39;) {
    el.setAttribute(&#39;class&#39;, &#39;x&#39;);
    if (el.className === &#39;x&#39;) {
      classProp = &#39;class&#39;;
    }
  }
  el = null;

  el = document.createElement(&#39;label&#39;);
  el.setAttribute(forProp, &#39;x&#39;);
  if (el.htmlFor !== &#39;x&#39;) {
    el.setAttribute(&#39;htmlFor&#39;, &#39;x&#39;);
    if (el.htmlFor === &#39;x&#39;) {
      forProp = &#39;htmlFor&#39;;
    }
  }
  el = null;

  return {
    read: {
      names: {
        &#39;class&#39;:      classProp,
        &#39;className&#39;:  classProp,
        &#39;for&#39;:        forProp,
        &#39;htmlFor&#39;:    forProp
      },
      values: {
        _getAttr: function(element, attribute) {
          return element.getAttribute(attribute);
        },
        _getAttr2: function(element, attribute) {
          return element.getAttribute(attribute, 2);
        },
        _getAttrNode: function(element, attribute) {
          var node = element.getAttributeNode(attribute);
          return node ? node.value : &quot;&quot;;
        },
        _getEv: (function(){

          var el = document.createElement(&#39;div&#39;), f;
          el.onclick = Prototype.emptyFunction;
          var value = el.getAttribute(&#39;onclick&#39;);

          if (String(value).indexOf(&#39;{&#39;) &gt; -1) {
            f = function(element, attribute) {
              attribute = element.getAttribute(attribute);
              if (!attribute) return null;
              attribute = attribute.toString();
              attribute = attribute.split(&#39;{&#39;)[1];
              attribute = attribute.split(&#39;}&#39;)[0];
              return attribute.strip();
            };
          }
          else if (value === &#39;&#39;) {
            f = function(element, attribute) {
              attribute = element.getAttribute(attribute);
              if (!attribute) return null;
              return attribute.strip();
            };
          }
          el = null;
          return f;
        })(),
        _flag: function(element, attribute) {
          return $(element).hasAttribute(attribute) ? attribute : null;
        },
        style: function(element) {
          return element.style.cssText.toLowerCase();
        },
        title: function(element) {
          return element.title;
        }
      }
    }
  }
})();

Element._attributeTranslations.write = {
  names: Object.extend({
    cellpadding: &#39;cellPadding&#39;,
    cellspacing: &#39;cellSpacing&#39;
  }, Element._attributeTranslations.read.names),
  values: {
    checked: function(element, value) {
      element.checked = !!value;
    },

    style: function(element, value) {
      element.style.cssText = value ? value : &#39;&#39;;
    }
  }
};

Element._attributeTranslations.has = {};

$w(&#39;colSpan rowSpan vAlign dateTime accessKey tabIndex &#39; +
    &#39;encType maxLength readOnly longDesc frameBorder&#39;).each(function(attr) {
  Element._attributeTranslations.write.names[attr.toLowerCase()] = attr;
  Element._attributeTranslations.has[attr.toLowerCase()] = attr;
});

(function(v) {
  Object.extend(v, {
    href:        v._getAttr2,
    src:         v._getAttr2,
    type:        v._getAttr,
    action:      v._getAttrNode,
    disabled:    v._flag,
    checked:     v._flag,
    readonly:    v._flag,
    multiple:    v._flag,
    onload:      v._getEv,
    onunload:    v._getEv,
    onclick:     v._getEv,
    ondblclick:  v._getEv,
    onmousedown: v._getEv,
    onmouseup:   v._getEv,
    onmouseover: v._getEv,
    onmousemove: v._getEv,
    onmouseout:  v._getEv,
    onfocus:     v._getEv,
    onblur:      v._getEv,
    onkeypress:  v._getEv,
    onkeydown:   v._getEv,
    onkeyup:     v._getEv,
    onsubmit:    v._getEv,
    onreset:     v._getEv,
    onselect:    v._getEv,
    onchange:    v._getEv
  });
})(Element._attributeTranslations.read.values);

if (Prototype.BrowserFeatures.ElementExtensions) {
  (function() {
    function _descendants(element) {
      var nodes = element.getElementsByTagName(&#39;*&#39;), results = [];
      for (var i = 0, node; node = nodes[i]; i++)
        if (node.tagName !== &quot;!&quot;) // Filter out comment nodes.
          results.push(node);
      return results;
    }

    Element.Methods.down = function(element, expression, index) {
      element = $(element);
      if (arguments.length == 1) return element.firstDescendant();
      return Object.isNumber(expression) ? _descendants(element)[expression] :
        Element.select(element, expression)[index || 0];
    }
  })();
}</pre>

<p>}</p>

<p>else if (Prototype.Browser.Gecko &amp;&amp;
/rv:1.8.0/.test(navigator.userAgent)) {</p>

<pre>Element.Methods.setOpacity = function(element, value) {
  element = $(element);
  element.style.opacity = (value == 1) ? 0.999999 :
    (value === &#39;&#39;) ? &#39;&#39; : (value &lt; 0.00001) ? 0 : value;
  return element;
};</pre>

<p>}</p>

<p>else if (Prototype.Browser.WebKit) {</p>

<pre>Element.Methods.setOpacity = function(element, value) {
  element = $(element);
  element.style.opacity = (value == 1 || value === &#39;&#39;) ? &#39;&#39; :
    (value &lt; 0.00001) ? 0 : value;

  if (value == 1)
    if (element.tagName.toUpperCase() == &#39;IMG&#39; &amp;&amp; element.width) {
      element.width++; element.width--;
    } else try {
      var n = document.createTextNode(&#39; &#39;);
      element.appendChild(n);
      element.removeChild(n);
    } catch (e) { }

  return element;
};

Element.Methods.cumulativeOffset = function(element) {
  var valueT = 0, valueL = 0;
  do {
    valueT += element.offsetTop  || 0;
    valueL += element.offsetLeft || 0;
    if (element.offsetParent == document.body)
      if (Element.getStyle(element, &#39;position&#39;) == &#39;absolute&#39;) break;

    element = element.offsetParent;
  } while (element);

  return Element._returnOffset(valueL, valueT);
};</pre>

<p>}</p>

<p>if (&#39;outerHTML&#39; in document.documentElement) {</p>

<pre>Element.Methods.replace = function(element, content) {
  element = $(element);

  if (content &amp;&amp; content.toElement) content = content.toElement();
  if (Object.isElement(content)) {
    element.parentNode.replaceChild(content, element);
    return element;
  }

  content = Object.toHTML(content);
  var parent = element.parentNode, tagName = parent.tagName.toUpperCase();

  if (Element._insertionTranslations.tags[tagName]) {
    var nextSibling = element.next(),
        fragments = Element._getContentFromAnonymousElement(tagName, content.stripScripts());
    parent.removeChild(element);
    if (nextSibling)
      fragments.each(function(node) { parent.insertBefore(node, nextSibling) });
    else
      fragments.each(function(node) { parent.appendChild(node) });
  }
  else element.outerHTML = content.stripScripts();

  content.evalScripts.bind(content).defer();
  return element;
};</pre>

<p>}</p>

<p>Element._returnOffset = function(l, t) {</p>

<pre class="ruby"><span class="ruby-identifier">var</span> <span class="ruby-identifier">result</span> = [<span class="ruby-identifier">l</span>, <span class="ruby-identifier">t</span>];
<span class="ruby-identifier">result</span>.<span class="ruby-identifier">left</span> = <span class="ruby-identifier">l</span>;
<span class="ruby-identifier">result</span>.<span class="ruby-identifier">top</span> = <span class="ruby-identifier">t</span>;
<span class="ruby-keyword">return</span> <span class="ruby-identifier">result</span>;
</pre>

<p>};</p>

<p>Element._getContentFromAnonymousElement = function(tagName, html) {</p>

<pre>var div = new Element(&#39;div&#39;),
    t = Element._insertionTranslations.tags[tagName];
if (t) {
  div.innerHTML = t[0] + html + t[1];
  for (var i = t[2]; i--; ) {
    div = div.firstChild;
  }
}
else {
  div.innerHTML = html;
}
return $A(div.childNodes);</pre>

<p>};</p>

<p>Element._insertionTranslations = {</p>

<pre>before: function(element, node) {
  element.parentNode.insertBefore(node, element);
},
top: function(element, node) {
  element.insertBefore(node, element.firstChild);
},
bottom: function(element, node) {
  element.appendChild(node);
},
after: function(element, node) {
  element.parentNode.insertBefore(node, element.nextSibling);
},
tags: {
  TABLE:  [&#39;&lt;table&gt;&#39;,                &#39;&lt;/table&gt;&#39;,                   1],
  TBODY:  [&#39;&lt;table&gt;&lt;tbody&gt;&#39;,         &#39;&lt;/tbody&gt;&lt;/table&gt;&#39;,           2],
  TR:     [&#39;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&#39;,     &#39;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&#39;,      3],
  TD:     [&#39;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&#39;, &#39;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&#39;, 4],
  SELECT: [&#39;&lt;select&gt;&#39;,               &#39;&lt;/select&gt;&#39;,                  1]
}</pre>

<p>};</p>

<p>(function() {</p>

<pre class="ruby"><span class="ruby-identifier">var</span> <span class="ruby-identifier">tags</span> = <span class="ruby-constant">Element</span>.<span class="ruby-identifier">_insertionTranslations</span>.<span class="ruby-identifier">tags</span>;
<span class="ruby-constant">Object</span>.<span class="ruby-identifier">extend</span>(<span class="ruby-identifier">tags</span>, {
  <span class="ruby-constant">THEAD</span><span class="ruby-operator">:</span> <span class="ruby-identifier">tags</span>.<span class="ruby-constant">TBODY</span>,
  <span class="ruby-constant">TFOOT</span><span class="ruby-operator">:</span> <span class="ruby-identifier">tags</span>.<span class="ruby-constant">TBODY</span>,
  <span class="ruby-constant">TH</span><span class="ruby-operator">:</span>    <span class="ruby-identifier">tags</span>.<span class="ruby-constant">TD</span>
});
</pre>

<p>})();</p>

<p>Element.Methods.Simulated = {</p>

<pre>hasAttribute: function(element, attribute) {
  attribute = Element._attributeTranslations.has[attribute] || attribute;
  var node = $(element).getAttributeNode(attribute);
  return !!(node &amp;&amp; node.specified);
}</pre>

<p>};</p>

<p>Element.Methods.ByTag = { };</p>

<p>Object.extend(Element, Element.Methods);</p>

<p>(function(div) {</p>

<pre>if (!Prototype.BrowserFeatures.ElementExtensions &amp;&amp; div[&#39;__proto__&#39;]) {
  window.HTMLElement = { };
  window.HTMLElement.prototype = div[&#39;__proto__&#39;];
  Prototype.BrowserFeatures.ElementExtensions = true;
}

div = null;</pre>

<p>})(document.createElement(&#39;div&#39;));</p>

<p>Element.extend = (function() {</p>

<pre>function checkDeficiency(tagName) {
  if (typeof window.Element != &#39;undefined&#39;) {
    var proto = window.Element.prototype;
    if (proto) {
      var id = &#39;_&#39; + (Math.random()+&#39;&#39;).slice(2),
          el = document.createElement(tagName);
      proto[id] = &#39;x&#39;;
      var isBuggy = (el[id] !== &#39;x&#39;);
      delete proto[id];
      el = null;
      return isBuggy;
    }
  }
  return false;
}

function extendElementWith(element, methods) {
  for (var property in methods) {
    var value = methods[property];
    if (Object.isFunction(value) &amp;&amp; !(property in element))
      element[property] = value.methodize();
  }
}

var HTMLOBJECTELEMENT_PROTOTYPE_BUGGY = checkDeficiency(&#39;object&#39;);

if (Prototype.BrowserFeatures.SpecificElementExtensions) {
  if (HTMLOBJECTELEMENT_PROTOTYPE_BUGGY) {
    return function(element) {
      if (element &amp;&amp; typeof element._extendedByPrototype == &#39;undefined&#39;) {
        var t = element.tagName;
        if (t &amp;&amp; (/^(?:object|applet|embed)$/i.test(t))) {
          extendElementWith(element, Element.Methods);
          extendElementWith(element, Element.Methods.Simulated);
          extendElementWith(element, Element.Methods.ByTag[t.toUpperCase()]);
        }
      }
      return element;
    }
  }
  return Prototype.K;
}

var Methods = { }, ByTag = Element.Methods.ByTag;

var extend = Object.extend(function(element) {
  if (!element || typeof element._extendedByPrototype != &#39;undefined&#39; ||
      element.nodeType != 1 || element == window) return element;

  var methods = Object.clone(Methods),
      tagName = element.tagName.toUpperCase();

  if (ByTag[tagName]) Object.extend(methods, ByTag[tagName]);

  extendElementWith(element, methods);

  element._extendedByPrototype = Prototype.emptyFunction;
  return element;

}, {
  refresh: function() {
    if (!Prototype.BrowserFeatures.ElementExtensions) {
      Object.extend(Methods, Element.Methods);
      Object.extend(Methods, Element.Methods.Simulated);
    }
  }
});

extend.refresh();
return extend;</pre>

<p>})();</p>

<p>if (document.documentElement.hasAttribute) {</p>

<pre class="ruby"><span class="ruby-constant">Element</span>.<span class="ruby-identifier">hasAttribute</span> = <span class="ruby-identifier">function</span>(<span class="ruby-identifier">element</span>, <span class="ruby-identifier">attribute</span>) {
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">element</span>.<span class="ruby-identifier">hasAttribute</span>(<span class="ruby-identifier">attribute</span>);
};
</pre>

<p>} else {</p>

<pre class="ruby"><span class="ruby-constant">Element</span>.<span class="ruby-identifier">hasAttribute</span> = <span class="ruby-constant">Element</span>.<span class="ruby-constant">Methods</span>.<span class="ruby-constant">Simulated</span>.<span class="ruby-identifier">hasAttribute</span>;
</pre>

<p>}</p>

<p>Element.addMethods = function(methods) {</p>

<pre>var F = Prototype.BrowserFeatures, T = Element.Methods.ByTag;

if (!methods) {
  Object.extend(Form, Form.Methods);
  Object.extend(Form.Element, Form.Element.Methods);
  Object.extend(Element.Methods.ByTag, {
    &quot;FORM&quot;:     Object.clone(Form.Methods),
    &quot;INPUT&quot;:    Object.clone(Form.Element.Methods),
    &quot;SELECT&quot;:   Object.clone(Form.Element.Methods),
    &quot;TEXTAREA&quot;: Object.clone(Form.Element.Methods)
  });
}

if (arguments.length == 2) {
  var tagName = methods;
  methods = arguments[1];
}

if (!tagName) Object.extend(Element.Methods, methods || { });
else {
  if (Object.isArray(tagName)) tagName.each(extend);
  else extend(tagName);
}

function extend(tagName) {
  tagName = tagName.toUpperCase();
  if (!Element.Methods.ByTag[tagName])
    Element.Methods.ByTag[tagName] = { };
  Object.extend(Element.Methods.ByTag[tagName], methods);
}

function copy(methods, destination, onlyIfAbsent) {
  onlyIfAbsent = onlyIfAbsent || false;
  for (var property in methods) {
    var value = methods[property];
    if (!Object.isFunction(value)) continue;
    if (!onlyIfAbsent || !(property in destination))
      destination[property] = value.methodize();
  }
}

function findDOMClass(tagName) {
  var klass;
  var trans = {
    &quot;OPTGROUP&quot;: &quot;OptGroup&quot;, &quot;TEXTAREA&quot;: &quot;TextArea&quot;, &quot;P&quot;: &quot;Paragraph&quot;,
    &quot;FIELDSET&quot;: &quot;FieldSet&quot;, &quot;UL&quot;: &quot;UList&quot;, &quot;OL&quot;: &quot;OList&quot;, &quot;DL&quot;: &quot;DList&quot;,
    &quot;DIR&quot;: &quot;Directory&quot;, &quot;H1&quot;: &quot;Heading&quot;, &quot;H2&quot;: &quot;Heading&quot;, &quot;H3&quot;: &quot;Heading&quot;,
    &quot;H4&quot;: &quot;Heading&quot;, &quot;H5&quot;: &quot;Heading&quot;, &quot;H6&quot;: &quot;Heading&quot;, &quot;Q&quot;: &quot;Quote&quot;,
    &quot;INS&quot;: &quot;Mod&quot;, &quot;DEL&quot;: &quot;Mod&quot;, &quot;A&quot;: &quot;Anchor&quot;, &quot;IMG&quot;: &quot;Image&quot;, &quot;CAPTION&quot;:
    &quot;TableCaption&quot;, &quot;COL&quot;: &quot;TableCol&quot;, &quot;COLGROUP&quot;: &quot;TableCol&quot;, &quot;THEAD&quot;:
    &quot;TableSection&quot;, &quot;TFOOT&quot;: &quot;TableSection&quot;, &quot;TBODY&quot;: &quot;TableSection&quot;, &quot;TR&quot;:
    &quot;TableRow&quot;, &quot;TH&quot;: &quot;TableCell&quot;, &quot;TD&quot;: &quot;TableCell&quot;, &quot;FRAMESET&quot;:
    &quot;FrameSet&quot;, &quot;IFRAME&quot;: &quot;IFrame&quot;
  };
  if (trans[tagName]) klass = &#39;HTML&#39; + trans[tagName] + &#39;Element&#39;;
  if (window[klass]) return window[klass];
  klass = &#39;HTML&#39; + tagName + &#39;Element&#39;;
  if (window[klass]) return window[klass];
  klass = &#39;HTML&#39; + tagName.capitalize() + &#39;Element&#39;;
  if (window[klass]) return window[klass];

  var element = document.createElement(tagName),
      proto = element[&#39;__proto__&#39;] || element.constructor.prototype;

  element = null;
  return proto;
}

var elementPrototype = window.HTMLElement ? HTMLElement.prototype :
 Element.prototype;

if (F.ElementExtensions) {
  copy(Element.Methods, elementPrototype);
  copy(Element.Methods.Simulated, elementPrototype, true);
}

if (F.SpecificElementExtensions) {
  for (var tag in Element.Methods.ByTag) {
    var klass = findDOMClass(tag);
    if (Object.isUndefined(klass)) continue;
    copy(T[tag], klass.prototype);
  }
}

Object.extend(Element, Element.Methods);
delete Element.ByTag;

if (Element.extend.refresh) Element.extend.refresh();
Element.cache = { };</pre>

<p>};</p>

<p>document.viewport = {</p>

<pre>getDimensions: function() {
  return { width: this.getWidth(), height: this.getHeight() };
},

getScrollOffsets: function() {
  return Element._returnOffset(
    window.pageXOffset || document.documentElement.scrollLeft || document.body.scrollLeft,
    window.pageYOffset || document.documentElement.scrollTop  || document.body.scrollTop);
}</pre>

<p>};</p>

<p>(function(viewport) {</p>

<pre>var B = Prototype.Browser, doc = document, element, property = {};

function getRootElement() {
  if (B.WebKit &amp;&amp; !doc.evaluate)
    return document;

  if (B.Opera &amp;&amp; window.parseFloat(window.opera.version()) &lt; 9.5)
    return document.body;

  return document.documentElement;
}

function define(D) {
  if (!element) element = getRootElement();

  property[D] = &#39;client&#39; + D;

  viewport[&#39;get&#39; + D] = function() { return element[property[D]] };
  return viewport[&#39;get&#39; + D]();
}

viewport.getWidth  = define.curry(&#39;Width&#39;);

viewport.getHeight = define.curry(&#39;Height&#39;);</pre>

<p>})(document.viewport);</p>

<p>Element.Storage = {</p>

<pre>UID: 1</pre>

<p>};</p>

<p>Element.addMethods({</p>

<pre>getStorage: function(element) {
  if (!(element = $(element))) return;

  var uid;
  if (element === window) {
    uid = 0;
  } else {
    if (typeof element._prototypeUID === &quot;undefined&quot;)
      element._prototypeUID = Element.Storage.UID++;
    uid = element._prototypeUID;
  }

  if (!Element.Storage[uid])
    Element.Storage[uid] = $H();

  return Element.Storage[uid];
},

store: function(element, key, value) {
  if (!(element = $(element))) return;

  if (arguments.length === 2) {
    Element.getStorage(element).update(key);
  } else {
    Element.getStorage(element).set(key, value);
  }

  return element;
},

retrieve: function(element, key, defaultValue) {
  if (!(element = $(element))) return;
  var hash = Element.getStorage(element), value = hash.get(key);

  if (Object.isUndefined(value)) {
    hash.set(key, defaultValue);
    value = defaultValue;
  }

  return value;
},

clone: function(element, deep) {
  if (!(element = $(element))) return;
  var clone = element.cloneNode(deep);
  clone._prototypeUID = void 0;
  if (deep) {
    var descendants = Element.select(clone, &#39;*&#39;),
        i = descendants.length;
    while (i--) {
      descendants[i]._prototypeUID = void 0;
    }
  }
  return Element.extend(clone);
},

purge: function(element) {
  if (!(element = $(element))) return;
  purgeElement(element);

  var descendants = element.getElementsByTagName(&#39;*&#39;),
   i = descendants.length;

  while (i--) purgeElement(descendants[i]);

  return null;
}</pre>

<p>});</p>

<p>(function() {</p>

<pre>function toDecimal(pctString) {
  var match = pctString.match(/^(\d+)%?$/i);
  if (!match) return null;
  return (Number(match[1]) / 100);
}

function getPixelValue(value, property) {
  if (Object.isElement(value)) {
    element = value;
    value = element.getStyle(property);
  }
  if (value === null) {
    return null;
  }

  if ((/^(?:-)?\d+(\.\d+)?(px)?$/i).test(value)) {
    return window.parseFloat(value);
  }

  if (/\d/.test(value) &amp;&amp; element.runtimeStyle) {
    var style = element.style.left, rStyle = element.runtimeStyle.left;
    element.runtimeStyle.left = element.currentStyle.left;
    element.style.left = value || 0;
    value = element.style.pixelLeft;
    element.style.left = style;
    element.runtimeStyle.left = rStyle;

    return value;
  }

  if (value.include(&#39;%&#39;)) {
    var decimal = toDecimal(value);
    var whole;
    if (property.include(&#39;left&#39;) || property.include(&#39;right&#39;) ||
     property.include(&#39;width&#39;)) {
      whole = $(element.parentNode).measure(&#39;width&#39;);
    } else if (property.include(&#39;top&#39;) || property.include(&#39;bottom&#39;) ||
     property.include(&#39;height&#39;)) {
      whole = $(element.parentNode).measure(&#39;height&#39;);
    }

    return whole * decimal;
  }

  return 0;
}

function toCSSPixels(number) {
  if (Object.isString(number) &amp;&amp; number.endsWith(&#39;px&#39;)) {
    return number;
  }
  return number + &#39;px&#39;;
}

function isDisplayed(element) {
  var originalElement = element;
  while (element &amp;&amp; element.parentNode) {
    var display = element.getStyle(&#39;display&#39;);
    if (display === &#39;none&#39;) {
      return false;
    }
    element = $(element.parentNode);
  }
  return true;
}

var hasLayout = Prototype.K;
if (&#39;currentStyle&#39; in document.documentElement) {
  hasLayout = function(element) {
    if (!element.currentStyle.hasLayout) {
      element.style.zoom = 1;
    }
    return element;
  };
}

function cssNameFor(key) {
  if (key.include(&#39;border&#39;)) key = key + &#39;-width&#39;;
  return key.camelize();
}

Element.Layout = Class.create(Hash, {
  initialize: function($super, element, preCompute) {
    $super();
    this.element = $(element);

    Element.Layout.PROPERTIES.each( function(property) {
      this._set(property, null);
    }, this);

    if (preCompute) {
      this._preComputing = true;
      this._begin();
      Element.Layout.PROPERTIES.each( this._compute, this );
      this._end();
      this._preComputing = false;
    }
  },

  _set: function(property, value) {
    return Hash.prototype.set.call(this, property, value);
  },

  set: function(property, value) {
    throw &quot;Properties of Element.Layout are read-only.&quot;;
  },

  get: function($super, property) {
    var value = $super(property);
    return value === null ? this._compute(property) : value;
  },

  _begin: function() {
    if (this._prepared) return;

    var element = this.element;
    if (isDisplayed(element)) {
      this._prepared = true;
      return;
    }

    var originalStyles = {
      position:   element.style.position   || &#39;&#39;,
      width:      element.style.width      || &#39;&#39;,
      visibility: element.style.visibility || &#39;&#39;,
      display:    element.style.display    || &#39;&#39;
    };

    element.store(&#39;prototype_original_styles&#39;, originalStyles);

    var position = element.getStyle(&#39;position&#39;),
     width = element.getStyle(&#39;width&#39;);

    element.setStyle({
      position:   &#39;absolute&#39;,
      visibility: &#39;hidden&#39;,
      display:    &#39;block&#39;
    });

    var positionedWidth = element.getStyle(&#39;width&#39;);

    var newWidth;
    if (width &amp;&amp; (positionedWidth === width)) {
      newWidth = getPixelValue(width);
    } else if (width &amp;&amp; (position === &#39;absolute&#39; || position === &#39;fixed&#39;)) {
      newWidth = getPixelValue(width);
    } else {
      var parent = element.parentNode, pLayout = $(parent).getLayout();

      newWidth = pLayout.get(&#39;width&#39;) -
       this.get(&#39;margin-left&#39;) -
       this.get(&#39;border-left&#39;) -
       this.get(&#39;padding-left&#39;) -
       this.get(&#39;padding-right&#39;) -
       this.get(&#39;border-right&#39;) -
       this.get(&#39;margin-right&#39;);
    }

    element.setStyle({ width: newWidth + &#39;px&#39; });

    this._prepared = true;
  },

  _end: function() {
    var element = this.element;
    var originalStyles = element.retrieve(&#39;prototype_original_styles&#39;);
    element.store(&#39;prototype_original_styles&#39;, null);
    element.setStyle(originalStyles);
    this._prepared = false;
  },

  _compute: function(property) {
    var COMPUTATIONS = Element.Layout.COMPUTATIONS;
    if (!(property in COMPUTATIONS)) {
      throw &quot;Property not found.&quot;;
    }
    return this._set(property, COMPUTATIONS[property].call(this, this.element));
  },

  toObject: function() {
    var args = $A(arguments);
    var keys = (args.length === 0) ? Element.Layout.PROPERTIES :
     args.join(&#39; &#39;).split(&#39; &#39;);
    var obj = {};
    keys.each( function(key) {
      if (!Element.Layout.PROPERTIES.include(key)) return;
      var value = this.get(key);
      if (value != null) obj[key] = value;
    }, this);
    return obj;
  },

  toHash: function() {
    var obj = this.toObject.apply(this, arguments);
    return new Hash(obj);
  },

  toCSS: function() {
    var args = $A(arguments);
    var keys = (args.length === 0) ? Element.Layout.PROPERTIES :
     args.join(&#39; &#39;).split(&#39; &#39;);
    var css = {};

    keys.each( function(key) {
      if (!Element.Layout.PROPERTIES.include(key)) return;
      if (Element.Layout.COMPOSITE_PROPERTIES.include(key)) return;

      var value = this.get(key);
      if (value != null) css[cssNameFor(key)] = value + &#39;px&#39;;
    }, this);
    return css;
  },

  inspect: function() {
    return &quot;#&lt;Element.Layout&gt;&quot;;
  }
});

Object.extend(Element.Layout, {
  PROPERTIES: $w(&#39;height width top left right bottom border-left border-right border-top border-bottom padding-left padding-right padding-top padding-bottom margin-top margin-bottom margin-left margin-right padding-box-width padding-box-height border-box-width border-box-height margin-box-width margin-box-height&#39;),

  COMPOSITE_PROPERTIES: $w(&#39;padding-box-width padding-box-height margin-box-width margin-box-height border-box-width border-box-height&#39;),

  COMPUTATIONS: {
    &#39;height&#39;: function(element) {
      if (!this._preComputing) this._begin();

      var bHeight = this.get(&#39;border-box-height&#39;);
      if (bHeight &lt;= 0) return 0;

      var bTop = this.get(&#39;border-top&#39;),
       bBottom = this.get(&#39;border-bottom&#39;);

      var pTop = this.get(&#39;padding-top&#39;),
       pBottom = this.get(&#39;padding-bottom&#39;);

      if (!this._preComputing) this._end();

      return bHeight - bTop - bBottom - pTop - pBottom;
    },

    &#39;width&#39;: function(element) {
      if (!this._preComputing) this._begin();

      var bWidth = this.get(&#39;border-box-width&#39;);
      if (bWidth &lt;= 0) return 0;

      var bLeft = this.get(&#39;border-left&#39;),
       bRight = this.get(&#39;border-right&#39;);

      var pLeft = this.get(&#39;padding-left&#39;),
       pRight = this.get(&#39;padding-right&#39;);

      if (!this._preComputing) this._end();

      return bWidth - bLeft - bRight - pLeft - pRight;
    },

    &#39;padding-box-height&#39;: function(element) {
      var height = this.get(&#39;height&#39;),
       pTop = this.get(&#39;padding-top&#39;),
       pBottom = this.get(&#39;padding-bottom&#39;);

      return height + pTop + pBottom;
    },

    &#39;padding-box-width&#39;: function(element) {
      var width = this.get(&#39;width&#39;),
       pLeft = this.get(&#39;padding-left&#39;),
       pRight = this.get(&#39;padding-right&#39;);

      return width + pLeft + pRight;
    },

    &#39;border-box-height&#39;: function(element) {
      return element.offsetHeight;
    },

    &#39;border-box-width&#39;: function(element) {
      return element.offsetWidth;
    },

    &#39;margin-box-height&#39;: function(element) {
      var bHeight = this.get(&#39;border-box-height&#39;),
       mTop = this.get(&#39;margin-top&#39;),
       mBottom = this.get(&#39;margin-bottom&#39;);

      if (bHeight &lt;= 0) return 0;

      return bHeight + mTop + mBottom;
    },

    &#39;margin-box-width&#39;: function(element) {
      var bWidth = this.get(&#39;border-box-width&#39;),
       mLeft = this.get(&#39;margin-left&#39;),
       mRight = this.get(&#39;margin-right&#39;);

      if (bWidth &lt;= 0) return 0;

      return bWidth + mLeft + mRight;
    },

    &#39;top&#39;: function(element) {
      var offset = element.positionedOffset();
      return offset.top;
    },

    &#39;bottom&#39;: function(element) {
      var offset = element.positionedOffset(),
       parent = element.getOffsetParent(),
       pHeight = parent.measure(&#39;height&#39;);

      var mHeight = this.get(&#39;border-box-height&#39;);

      return pHeight - mHeight - offset.top;
    },

    &#39;left&#39;: function(element) {
      var offset = element.positionedOffset();
      return offset.left;
    },

    &#39;right&#39;: function(element) {
      var offset = element.positionedOffset(),
       parent = element.getOffsetParent(),
       pWidth = parent.measure(&#39;width&#39;);

      var mWidth = this.get(&#39;border-box-width&#39;);

      return pWidth - mWidth - offset.left;
    },

    &#39;padding-top&#39;: function(element) {
      return getPixelValue(element, &#39;paddingTop&#39;);
    },

    &#39;padding-bottom&#39;: function(element) {
      return getPixelValue(element, &#39;paddingBottom&#39;);
    },

    &#39;padding-left&#39;: function(element) {
      return getPixelValue(element, &#39;paddingLeft&#39;);
    },

    &#39;padding-right&#39;: function(element) {
      return getPixelValue(element, &#39;paddingRight&#39;);
    },

    &#39;border-top&#39;: function(element) {
      return Object.isNumber(element.clientTop) ? element.clientTop :
       getPixelValue(element, &#39;borderTopWidth&#39;);
    },

    &#39;border-bottom&#39;: function(element) {
      return Object.isNumber(element.clientBottom) ? element.clientBottom :
       getPixelValue(element, &#39;borderBottomWidth&#39;);
    },

    &#39;border-left&#39;: function(element) {
      return Object.isNumber(element.clientLeft) ? element.clientLeft :
       getPixelValue(element, &#39;borderLeftWidth&#39;);
    },

    &#39;border-right&#39;: function(element) {
      return Object.isNumber(element.clientRight) ? element.clientRight :
       getPixelValue(element, &#39;borderRightWidth&#39;);
    },

    &#39;margin-top&#39;: function(element) {
      return getPixelValue(element, &#39;marginTop&#39;);
    },

    &#39;margin-bottom&#39;: function(element) {
      return getPixelValue(element, &#39;marginBottom&#39;);
    },

    &#39;margin-left&#39;: function(element) {
      return getPixelValue(element, &#39;marginLeft&#39;);
    },

    &#39;margin-right&#39;: function(element) {
      return getPixelValue(element, &#39;marginRight&#39;);
    }
  }
});

if (&#39;getBoundingClientRect&#39; in document.documentElement) {
  Object.extend(Element.Layout.COMPUTATIONS, {
    &#39;right&#39;: function(element) {
      var parent = hasLayout(element.getOffsetParent());
      var rect = element.getBoundingClientRect(),
       pRect = parent.getBoundingClientRect();

      return (pRect.right - rect.right).round();
    },

    &#39;bottom&#39;: function(element) {
      var parent = hasLayout(element.getOffsetParent());
      var rect = element.getBoundingClientRect(),
       pRect = parent.getBoundingClientRect();

      return (pRect.bottom - rect.bottom).round();
    }
  });
}

Element.Offset = Class.create({
  initialize: function(left, top) {
    this.left = left.round();
    this.top  = top.round();

    this[0] = this.left;
    this[1] = this.top;
  },

  relativeTo: function(offset) {
    return new Element.Offset(
      this.left - offset.left,
      this.top  - offset.top
    );
  },

  inspect: function() {
    return &quot;#&lt;Element.Offset left: #{left} top: #{top}&gt;&quot;.interpolate(this);
  },

  toString: function() {
    return &quot;[#{left}, #{top}]&quot;.interpolate(this);
  },

  toArray: function() {
    return [this.left, this.top];
  }
});

function getLayout(element, preCompute) {
  return new Element.Layout(element, preCompute);
}

function measure(element, property) {
  return $(element).getLayout().get(property);
}

function getDimensions(element) {
  var layout = $(element).getLayout();
  return {
    width:  layout.get(&#39;width&#39;),
    height: layout.get(&#39;height&#39;)
  };
}

function getOffsetParent(element) {
  if (isDetached(element)) return $(document.body);

  var isInline = (Element.getStyle(element, &#39;display&#39;) === &#39;inline&#39;);
  if (!isInline &amp;&amp; element.offsetParent) return $(element.offsetParent);
  if (element === document.body) return $(element);

  while ((element = element.parentNode) &amp;&amp; element !== document.body) {
    if (Element.getStyle(element, &#39;position&#39;) !== &#39;static&#39;) {
      return (element.nodeName === &#39;HTML&#39;) ? $(document.body) : $(element);
    }
  }

  return $(document.body);
}

function cumulativeOffset(element) {
  var valueT = 0, valueL = 0;
  do {
    valueT += element.offsetTop  || 0;
    valueL += element.offsetLeft || 0;
    element = element.offsetParent;
  } while (element);
  return new Element.Offset(valueL, valueT);
}

function positionedOffset(element) {
  var layout = element.getLayout();

  var valueT = 0, valueL = 0;
  do {
    valueT += element.offsetTop  || 0;
    valueL += element.offsetLeft || 0;
    element = element.offsetParent;
    if (element) {
      if (isBody(element)) break;
      var p = Element.getStyle(element, &#39;position&#39;);
      if (p !== &#39;static&#39;) break;
    }
  } while (element);

  valueL -= layout.get(&#39;margin-top&#39;);
  valueT -= layout.get(&#39;margin-left&#39;);

  return new Element.Offset(valueL, valueT);
}

function cumulativeScrollOffset(element) {
  var valueT = 0, valueL = 0;
  do {
    valueT += element.scrollTop  || 0;
    valueL += element.scrollLeft || 0;
    element = element.parentNode;
  } while (element);
  return new Element.Offset(valueL, valueT);
}

function viewportOffset(forElement) {
  var valueT = 0, valueL = 0, docBody = document.body;

  var element = forElement;
  do {
    valueT += element.offsetTop  || 0;
    valueL += element.offsetLeft || 0;
    if (element.offsetParent == docBody &amp;&amp;
      Element.getStyle(element, &#39;position&#39;) == &#39;absolute&#39;) break;
  } while (element = element.offsetParent);

  element = forElement;
  do {
    if (element != docBody) {
      valueT -= element.scrollTop  || 0;
      valueL -= element.scrollLeft || 0;
    }
  } while (element = element.parentNode);
  return new Element.Offset(valueL, valueT);
}

function absolutize(element) {
  element = $(element);

  if (Element.getStyle(element, &#39;position&#39;) === &#39;absolute&#39;) {
    return element;
  }

  var offsetParent = getOffsetParent(element);
  var eOffset = element.viewportOffset(),
   pOffset = offsetParent.viewportOffset();

  var offset = eOffset.relativeTo(pOffset);
  var layout = element.getLayout();

  element.store(&#39;prototype_absolutize_original_styles&#39;, {
    left:   element.getStyle(&#39;left&#39;),
    top:    element.getStyle(&#39;top&#39;),
    width:  element.getStyle(&#39;width&#39;),
    height: element.getStyle(&#39;height&#39;)
  });

  element.setStyle({
    position: &#39;absolute&#39;,
    top:    offset.top + &#39;px&#39;,
    left:   offset.left + &#39;px&#39;,
    width:  layout.get(&#39;width&#39;) + &#39;px&#39;,
    height: layout.get(&#39;height&#39;) + &#39;px&#39;
  });

  return element;
}

function relativize(element) {
  element = $(element);
  if (Element.getStyle(element, &#39;position&#39;) === &#39;relative&#39;) {
    return element;
  }

  var originalStyles =
   element.retrieve(&#39;prototype_absolutize_original_styles&#39;);

  if (originalStyles) element.setStyle(originalStyles);
  return element;
}

Element.addMethods({
  getLayout:              getLayout,
  measure:                measure,
  getDimensions:          getDimensions,
  getOffsetParent:        getOffsetParent,
  cumulativeOffset:       cumulativeOffset,
  positionedOffset:       positionedOffset,
  cumulativeScrollOffset: cumulativeScrollOffset,
  viewportOffset:         viewportOffset,
  absolutize:             absolutize,
  relativize:             relativize
});

function isBody(element) {
  return element.nodeName.toUpperCase() === &#39;BODY&#39;;
}

function isDetached(element) {
  return element !== document.body &amp;&amp;
   !Element.descendantOf(element, document.body);
}

if (&#39;getBoundingClientRect&#39; in document.documentElement) {
  Element.addMethods({
    viewportOffset: function(element) {
      element = $(element);
      if (isDetached(element)) return new Element.Offset(0, 0);

      var rect  = element.getBoundingClientRect(),
       docEl = document.documentElement;
      return new Element.Offset(rect.left - docEl.clientLeft,
       rect.top - docEl.clientTop);
    },

    positionedOffset: function(element) {
      element = $(element);
      var parent = element.getOffsetParent();
      if (isDetached(element)) return new Element.Offset(0, 0);

      if (element.offsetParent &amp;&amp;
       element.offsetParent.nodeName.toUpperCase() === &#39;HTML&#39;) {
        return positionedOffset(element);
      }

      var eOffset = element.viewportOffset(),
       pOffset = isBody(parent) ? viewportOffset(parent) :
        parent.viewportOffset();
      var retOffset = eOffset.relativeTo(pOffset);

      var layout = element.getLayout();
      var top  = retOffset.top  - layout.get(&#39;margin-top&#39;);
      var left = retOffset.left - layout.get(&#39;margin-left&#39;);

      return new Element.Offset(left, top);
    }
  });
}</pre>

<p>})(); window.$$ = function() {</p>

<pre>var expression = $A(arguments).join(&#39;, &#39;);
return Prototype.Selector.select(expression, document);</pre>

<p>};</p>

<p>Prototype.Selector = (function() {</p>

<pre>function select() {
  throw new Error(&#39;Method &quot;Prototype.Selector.select&quot; must be defined.&#39;);
}

function match() {
  throw new Error(&#39;Method &quot;Prototype.Selector.match&quot; must be defined.&#39;);
}

function find(elements, expression, index) {
  index = index || 0;
  var match = Prototype.Selector.match, length = elements.length, matchIndex = 0, i;

  for (i = 0; i &lt; length; i++) {
    if (match(elements[i], expression) &amp;&amp; index == matchIndex++) {
      return Element.extend(elements[i]);
    }
  }
}

function extendElements(elements) {
  for (var i = 0, length = elements.length; i &lt; length; i++) {
    Element.extend(elements[i]);
  }
  return elements;
}

var K = Prototype.K;

return {
  select: select,
  match: match,
  find: find,
  extendElements: (Element.extend === K) ? K : extendElements,
  extendElement: Element.extend
};</pre>

<p>})(); Prototype._original_property = window.Sizzle; /*!</p>

<pre> Sizzle CSS Selector Engine - v1.0
  Copyright 2009, The Dojo Foundation
  Released under the MIT, BSD, and GPL Licenses.
  More information: http://sizzlejs.com/
/</pre>

<p>(function(){</p>

<p>var chunker =
/((?:((?:([^()]+)|[^()]+)+)|[(?:[[^[]]*]|[&#39;“][^&#39;”]*[&#39;“]|[^[]&#39;”]+)+]|\.|[^
&gt;+~,([\]+)+|[&gt;+~])(s*,s*)?((?:.|r|n)*)/g,</p>

<pre class="ruby"><span class="ruby-identifier">done</span> = <span class="ruby-value">0</span>,
<span class="ruby-identifier">toString</span> = <span class="ruby-constant">Object</span>.<span class="ruby-identifier">prototype</span>.<span class="ruby-identifier">toString</span>,
<span class="ruby-identifier">hasDuplicate</span> = <span class="ruby-keyword">false</span>,
<span class="ruby-identifier">baseHasDuplicate</span> = <span class="ruby-keyword">true</span>;
</pre>

<p>[0, 0].sort(function(){</p>

<pre class="ruby"><span class="ruby-identifier">baseHasDuplicate</span> = <span class="ruby-keyword">false</span>;
<span class="ruby-keyword">return</span> <span class="ruby-value">0</span>;
</pre>

<p>});</p>

<p>var Sizzle = function(selector, context, results, seed) {</p>

<pre>results = results || [];
var origContext = context = context || document;

if ( context.nodeType !== 1 &amp;&amp; context.nodeType !== 9 ) {
        return [];
}

if ( !selector || typeof selector !== &quot;string&quot; ) {
        return results;
}

var parts = [], m, set, checkSet, check, mode, extra, prune = true, contextXML = isXML(context),
        soFar = selector;

while ( (chunker.exec(&quot;&quot;), m = chunker.exec(soFar)) !== null ) {
        soFar = m[3];

        parts.push( m[1] );

        if ( m[2] ) {
                extra = m[3];
                break;
        }
}

if ( parts.length &gt; 1 &amp;&amp; origPOS.exec( selector ) ) {
        if ( parts.length === 2 &amp;&amp; Expr.relative[ parts[0] ] ) {
                set = posProcess( parts[0] + parts[1], context );
        } else {
                set = Expr.relative[ parts[0] ] ?
                        [ context ] :
                        Sizzle( parts.shift(), context );

                while ( parts.length ) {
                        selector = parts.shift();

                        if ( Expr.relative[ selector ] )
                                selector += parts.shift();

                        set = posProcess( selector, set );
                }
        }
} else {
        if ( !seed &amp;&amp; parts.length &gt; 1 &amp;&amp; context.nodeType === 9 &amp;&amp; !contextXML &amp;&amp;
                        Expr.match.ID.test(parts[0]) &amp;&amp; !Expr.match.ID.test(parts[parts.length - 1]) ) {
                var ret = Sizzle.find( parts.shift(), context, contextXML );
                context = ret.expr ? Sizzle.filter( ret.expr, ret.set )[0] : ret.set[0];
        }

        if ( context ) {
                var ret = seed ?
                        { expr: parts.pop(), set: makeArray(seed) } :
                        Sizzle.find( parts.pop(), parts.length === 1 &amp;&amp; (parts[0] === &quot;~&quot; || parts[0] === &quot;+&quot;) &amp;&amp; context.parentNode ? context.parentNode : context, contextXML );
                set = ret.expr ? Sizzle.filter( ret.expr, ret.set ) : ret.set;

                if ( parts.length &gt; 0 ) {
                        checkSet = makeArray(set);
                } else {
                        prune = false;
                }

                while ( parts.length ) {
                        var cur = parts.pop(), pop = cur;

                        if ( !Expr.relative[ cur ] ) {
                                cur = &quot;&quot;;
                        } else {
                                pop = parts.pop();
                        }

                        if ( pop == null ) {
                                pop = context;
                        }

                        Expr.relative[ cur ]( checkSet, pop, contextXML );
                }
        } else {
                checkSet = parts = [];
        }
}

if ( !checkSet ) {
        checkSet = set;
}

if ( !checkSet ) {
        throw &quot;Syntax error, unrecognized expression: &quot; + (cur || selector);
}

if ( toString.call(checkSet) === &quot;[object Array]&quot; ) {
        if ( !prune ) {
                results.push.apply( results, checkSet );
        } else if ( context &amp;&amp; context.nodeType === 1 ) {
                for ( var i = 0; checkSet[i] != null; i++ ) {
                        if ( checkSet[i] &amp;&amp; (checkSet[i] === true || checkSet[i].nodeType === 1 &amp;&amp; contains(context, checkSet[i])) ) {
                                results.push( set[i] );
                        }
                }
        } else {
                for ( var i = 0; checkSet[i] != null; i++ ) {
                        if ( checkSet[i] &amp;&amp; checkSet[i].nodeType === 1 ) {
                                results.push( set[i] );
                        }
                }
        }
} else {
        makeArray( checkSet, results );
}

if ( extra ) {
        Sizzle( extra, origContext, results, seed );
        Sizzle.uniqueSort( results );
}

return results;</pre>

<p>};</p>

<p>Sizzle.uniqueSort = function(results){</p>

<pre>if ( sortOrder ) {
        hasDuplicate = baseHasDuplicate;
        results.sort(sortOrder);

        if ( hasDuplicate ) {
                for ( var i = 1; i &lt; results.length; i++ ) {
                        if ( results[i] === results[i-1] ) {
                                results.splice(i--, 1);
                        }
                }
        }
}

return results;</pre>

<p>};</p>

<p>Sizzle.matches = function(expr, set){</p>

<pre class="ruby"><span class="ruby-keyword">return</span> <span class="ruby-constant">Sizzle</span>(<span class="ruby-identifier">expr</span>, <span class="ruby-identifier">null</span>, <span class="ruby-identifier">null</span>, <span class="ruby-identifier">set</span>);
</pre>

<p>};</p>

<p>Sizzle.find = function(expr, context, isXML){</p>

<pre>var set, match;

if ( !expr ) {
        return [];
}

for ( var i = 0, l = Expr.order.length; i &lt; l; i++ ) {
        var type = Expr.order[i], match;

        if ( (match = Expr.leftMatch[ type ].exec( expr )) ) {
                var left = match[1];
                match.splice(1,1);

                if ( left.substr( left.length - 1 ) !== &quot;\\&quot; ) {
                        match[1] = (match[1] || &quot;&quot;).replace(/\\/g, &quot;&quot;);
                        set = Expr.find[ type ]( match, context, isXML );
                        if ( set != null ) {
                                expr = expr.replace( Expr.match[ type ], &quot;&quot; );
                                break;
                        }
                }
        }
}

if ( !set ) {
        set = context.getElementsByTagName(&quot;*&quot;);
}

return {set: set, expr: expr};</pre>

<p>};</p>

<p>Sizzle.filter = function(expr, set, inplace, not){</p>

<pre>var old = expr, result = [], curLoop = set, match, anyFound,
        isXMLFilter = set &amp;&amp; set[0] &amp;&amp; isXML(set[0]);

while ( expr &amp;&amp; set.length ) {
        for ( var type in Expr.filter ) {
                if ( (match = Expr.match[ type ].exec( expr )) != null ) {
                        var filter = Expr.filter[ type ], found, item;
                        anyFound = false;

                        if ( curLoop == result ) {
                                result = [];
                        }

                        if ( Expr.preFilter[ type ] ) {
                                match = Expr.preFilter[ type ]( match, curLoop, inplace, result, not, isXMLFilter );

                                if ( !match ) {
                                        anyFound = found = true;
                                } else if ( match === true ) {
                                        continue;
                                }
                        }

                        if ( match ) {
                                for ( var i = 0; (item = curLoop[i]) != null; i++ ) {
                                        if ( item ) {
                                                found = filter( item, match, i, curLoop );
                                                var pass = not ^ !!found;

                                                if ( inplace &amp;&amp; found != null ) {
                                                        if ( pass ) {
                                                                anyFound = true;
                                                        } else {
                                                                curLoop[i] = false;
                                                        }
                                                } else if ( pass ) {
                                                        result.push( item );
                                                        anyFound = true;
                                                }
                                        }
                                }
                        }

                        if ( found !== undefined ) {
                                if ( !inplace ) {
                                        curLoop = result;
                                }

                                expr = expr.replace( Expr.match[ type ], &quot;&quot; );

                                if ( !anyFound ) {
                                        return [];
                                }

                                break;
                        }
                }
        }

        if ( expr == old ) {
                if ( anyFound == null ) {
                        throw &quot;Syntax error, unrecognized expression: &quot; + expr;
                } else {
                        break;
                }
        }

        old = expr;
}

return curLoop;</pre>

<p>};</p>

<p>var Expr = Sizzle.selectors = {</p>

<pre>order: [ &quot;ID&quot;, &quot;NAME&quot;, &quot;TAG&quot; ],
match: {
        ID: /#((?:[\w\u00c0-\uFFFF-]|\\.)+)/,
        CLASS: /\.((?:[\w\u00c0-\uFFFF-]|\\.)+)/,
        NAME: /\[name=[&#39;&quot;]*((?:[\w\u00c0-\uFFFF-]|\\.)+)[&#39;&quot;]*\]/,
        ATTR: /\[\s*((?:[\w\u00c0-\uFFFF-]|\\.)+)\s*(?:(\S?=)\s*([&#39;&quot;]*)(.*?)\3|)\s*\]/,
        TAG: /^((?:[\w\u00c0-\uFFFF\*-]|\\.)+)/,
        CHILD: /:(only|nth|last|first)-child(?:\((even|odd|[\dn+-]*)\))?/,
        POS: /:(nth|eq|gt|lt|first|last|even|odd)(?:\((\d*)\))?(?=[^-]|$)/,
        PSEUDO: /:((?:[\w\u00c0-\uFFFF-]|\\.)+)(?:\(([&#39;&quot;]*)((?:\([^\)]+\)|[^\2\(\)]*)+)\2\))?/
},
leftMatch: {},
attrMap: {
        &quot;class&quot;: &quot;className&quot;,
        &quot;for&quot;: &quot;htmlFor&quot;
},
attrHandle: {
        href: function(elem){
                return elem.getAttribute(&quot;href&quot;);
        }
},
relative: {
        &quot;+&quot;: function(checkSet, part, isXML){
                var isPartStr = typeof part === &quot;string&quot;,
                        isTag = isPartStr &amp;&amp; !/\W/.test(part),
                        isPartStrNotTag = isPartStr &amp;&amp; !isTag;

                if ( isTag &amp;&amp; !isXML ) {
                        part = part.toUpperCase();
                }

                for ( var i = 0, l = checkSet.length, elem; i &lt; l; i++ ) {
                        if ( (elem = checkSet[i]) ) {
                                while ( (elem = elem.previousSibling) &amp;&amp; elem.nodeType !== 1 ) {}

                                checkSet[i] = isPartStrNotTag || elem &amp;&amp; elem.nodeName === part ?
                                        elem || false :
                                        elem === part;
                        }
                }

                if ( isPartStrNotTag ) {
                        Sizzle.filter( part, checkSet, true );
                }
        },
        &quot;&gt;&quot;: function(checkSet, part, isXML){
                var isPartStr = typeof part === &quot;string&quot;;

                if ( isPartStr &amp;&amp; !/\W/.test(part) ) {
                        part = isXML ? part : part.toUpperCase();

                        for ( var i = 0, l = checkSet.length; i &lt; l; i++ ) {
                                var elem = checkSet[i];
                                if ( elem ) {
                                        var parent = elem.parentNode;
                                        checkSet[i] = parent.nodeName === part ? parent : false;
                                }
                        }
                } else {
                        for ( var i = 0, l = checkSet.length; i &lt; l; i++ ) {
                                var elem = checkSet[i];
                                if ( elem ) {
                                        checkSet[i] = isPartStr ?
                                                elem.parentNode :
                                                elem.parentNode === part;
                                }
                        }

                        if ( isPartStr ) {
                                Sizzle.filter( part, checkSet, true );
                        }
                }
        },
        &quot;&quot;: function(checkSet, part, isXML){
                var doneName = done++, checkFn = dirCheck;

                if ( !/\W/.test(part) ) {
                        var nodeCheck = part = isXML ? part : part.toUpperCase();
                        checkFn = dirNodeCheck;
                }

                checkFn(&quot;parentNode&quot;, part, doneName, checkSet, nodeCheck, isXML);
        },
        &quot;~&quot;: function(checkSet, part, isXML){
                var doneName = done++, checkFn = dirCheck;

                if ( typeof part === &quot;string&quot; &amp;&amp; !/\W/.test(part) ) {
                        var nodeCheck = part = isXML ? part : part.toUpperCase();
                        checkFn = dirNodeCheck;
                }

                checkFn(&quot;previousSibling&quot;, part, doneName, checkSet, nodeCheck, isXML);
        }
},
find: {
        ID: function(match, context, isXML){
                if ( typeof context.getElementById !== &quot;undefined&quot; &amp;&amp; !isXML ) {
                        var m = context.getElementById(match[1]);
                        return m ? [m] : [];
                }
        },
        NAME: function(match, context, isXML){
                if ( typeof context.getElementsByName !== &quot;undefined&quot; ) {
                        var ret = [], results = context.getElementsByName(match[1]);

                        for ( var i = 0, l = results.length; i &lt; l; i++ ) {
                                if ( results[i].getAttribute(&quot;name&quot;) === match[1] ) {
                                        ret.push( results[i] );
                                }
                        }

                        return ret.length === 0 ? null : ret;
                }
        },
        TAG: function(match, context){
                return context.getElementsByTagName(match[1]);
        }
},
preFilter: {
        CLASS: function(match, curLoop, inplace, result, not, isXML){
                match = &quot; &quot; + match[1].replace(/\\/g, &quot;&quot;) + &quot; &quot;;

                if ( isXML ) {
                        return match;
                }

                for ( var i = 0, elem; (elem = curLoop[i]) != null; i++ ) {
                        if ( elem ) {
                                if ( not ^ (elem.className &amp;&amp; (&quot; &quot; + elem.className + &quot; &quot;).indexOf(match) &gt;= 0) ) {
                                        if ( !inplace )
                                                result.push( elem );
                                } else if ( inplace ) {
                                        curLoop[i] = false;
                                }
                        }
                }

                return false;
        },
        ID: function(match){
                return match[1].replace(/\\/g, &quot;&quot;);
        },
        TAG: function(match, curLoop){
                for ( var i = 0; curLoop[i] === false; i++ ){}
                return curLoop[i] &amp;&amp; isXML(curLoop[i]) ? match[1] : match[1].toUpperCase();
        },
        CHILD: function(match){
                if ( match[1] == &quot;nth&quot; ) {
                        var test = /(-?)(\d*)n((?:\+|-)?\d*)/.exec(
                                match[2] == &quot;even&quot; &amp;&amp; &quot;2n&quot; || match[2] == &quot;odd&quot; &amp;&amp; &quot;2n+1&quot; ||
                                !/\D/.test( match[2] ) &amp;&amp; &quot;0n+&quot; + match[2] || match[2]);

                        match[2] = (test[1] + (test[2] || 1)) - 0;
                        match[3] = test[3] - 0;
                }

                match[0] = done++;

                return match;
        },
        ATTR: function(match, curLoop, inplace, result, not, isXML){
                var name = match[1].replace(/\\/g, &quot;&quot;);

                if ( !isXML &amp;&amp; Expr.attrMap[name] ) {
                        match[1] = Expr.attrMap[name];
                }

                if ( match[2] === &quot;~=&quot; ) {
                        match[4] = &quot; &quot; + match[4] + &quot; &quot;;
                }

                return match;
        },
        PSEUDO: function(match, curLoop, inplace, result, not){
                if ( match[1] === &quot;not&quot; ) {
                        if ( ( chunker.exec(match[3]) || &quot;&quot; ).length &gt; 1 || /^\w/.test(match[3]) ) {
                                match[3] = Sizzle(match[3], null, null, curLoop);
                        } else {
                                var ret = Sizzle.filter(match[3], curLoop, inplace, true ^ not);
                                if ( !inplace ) {
                                        result.push.apply( result, ret );
                                }
                                return false;
                        }
                } else if ( Expr.match.POS.test( match[0] ) || Expr.match.CHILD.test( match[0] ) ) {
                        return true;
                }

                return match;
        },
        POS: function(match){
                match.unshift( true );
                return match;
        }
},
filters: {
        enabled: function(elem){
                return elem.disabled === false &amp;&amp; elem.type !== &quot;hidden&quot;;
        },
        disabled: function(elem){
                return elem.disabled === true;
        },
        checked: function(elem){
                return elem.checked === true;
        },
        selected: function(elem){
                elem.parentNode.selectedIndex;
                return elem.selected === true;
        },
        parent: function(elem){
                return !!elem.firstChild;
        },
        empty: function(elem){
                return !elem.firstChild;
        },
        has: function(elem, i, match){
                return !!Sizzle( match[3], elem ).length;
        },
        header: function(elem){
                return /h\d/i.test( elem.nodeName );
        },
        text: function(elem){
                return &quot;text&quot; === elem.type;
        },
        radio: function(elem){
                return &quot;radio&quot; === elem.type;
        },
        checkbox: function(elem){
                return &quot;checkbox&quot; === elem.type;
        },
        file: function(elem){
                return &quot;file&quot; === elem.type;
        },
        password: function(elem){
                return &quot;password&quot; === elem.type;
        },
        submit: function(elem){
                return &quot;submit&quot; === elem.type;
        },
        image: function(elem){
                return &quot;image&quot; === elem.type;
        },
        reset: function(elem){
                return &quot;reset&quot; === elem.type;
        },
        button: function(elem){
                return &quot;button&quot; === elem.type || elem.nodeName.toUpperCase() === &quot;BUTTON&quot;;
        },
        input: function(elem){
                return /input|select|textarea|button/i.test(elem.nodeName);
        }
},
setFilters: {
        first: function(elem, i){
                return i === 0;
        },
        last: function(elem, i, match, array){
                return i === array.length - 1;
        },
        even: function(elem, i){
                return i % 2 === 0;
        },
        odd: function(elem, i){
                return i % 2 === 1;
        },
        lt: function(elem, i, match){
                return i &lt; match[3] - 0;
        },
        gt: function(elem, i, match){
                return i &gt; match[3] - 0;
        },
        nth: function(elem, i, match){
                return match[3] - 0 == i;
        },
        eq: function(elem, i, match){
                return match[3] - 0 == i;
        }
},
filter: {
        PSEUDO: function(elem, match, i, array){
                var name = match[1], filter = Expr.filters[ name ];

                if ( filter ) {
                        return filter( elem, i, match, array );
                } else if ( name === &quot;contains&quot; ) {
                        return (elem.textContent || elem.innerText || &quot;&quot;).indexOf(match[3]) &gt;= 0;
                } else if ( name === &quot;not&quot; ) {
                        var not = match[3];

                        for ( var i = 0, l = not.length; i &lt; l; i++ ) {
                                if ( not[i] === elem ) {
                                        return false;
                                }
                        }

                        return true;
                }
        },
        CHILD: function(elem, match){
                var type = match[1], node = elem;
                switch (type) {
                        case &#39;only&#39;:
                        case &#39;first&#39;:
                                while ( (node = node.previousSibling) )  {
                                        if ( node.nodeType === 1 ) return false;
                                }
                                if ( type == &#39;first&#39;) return true;
                                node = elem;
                        case &#39;last&#39;:
                                while ( (node = node.nextSibling) )  {
                                        if ( node.nodeType === 1 ) return false;
                                }
                                return true;
                        case &#39;nth&#39;:
                                var first = match[2], last = match[3];

                                if ( first == 1 &amp;&amp; last == 0 ) {
                                        return true;
                                }

                                var doneName = match[0],
                                        parent = elem.parentNode;

                                if ( parent &amp;&amp; (parent.sizcache !== doneName || !elem.nodeIndex) ) {
                                        var count = 0;
                                        for ( node = parent.firstChild; node; node = node.nextSibling ) {
                                                if ( node.nodeType === 1 ) {
                                                        node.nodeIndex = ++count;
                                                }
                                        }
                                        parent.sizcache = doneName;
                                }

                                var diff = elem.nodeIndex - last;
                                if ( first == 0 ) {
                                        return diff == 0;
                                } else {
                                        return ( diff % first == 0 &amp;&amp; diff / first &gt;= 0 );
                                }
                }
        },
        ID: function(elem, match){
                return elem.nodeType === 1 &amp;&amp; elem.getAttribute(&quot;id&quot;) === match;
        },
        TAG: function(elem, match){
                return (match === &quot;*&quot; &amp;&amp; elem.nodeType === 1) || elem.nodeName === match;
        },
        CLASS: function(elem, match){
                return (&quot; &quot; + (elem.className || elem.getAttribute(&quot;class&quot;)) + &quot; &quot;)
                        .indexOf( match ) &gt; -1;
        },
        ATTR: function(elem, match){
                var name = match[1],
                        result = Expr.attrHandle[ name ] ?
                                Expr.attrHandle[ name ]( elem ) :
                                elem[ name ] != null ?
                                        elem[ name ] :
                                        elem.getAttribute( name ),
                        value = result + &quot;&quot;,
                        type = match[2],
                        check = match[4];

                return result == null ?
                        type === &quot;!=&quot; :
                        type === &quot;=&quot; ?
                        value === check :
                        type === &quot;*=&quot; ?
                        value.indexOf(check) &gt;= 0 :
                        type === &quot;~=&quot; ?
                        (&quot; &quot; + value + &quot; &quot;).indexOf(check) &gt;= 0 :
                        !check ?
                        value &amp;&amp; result !== false :
                        type === &quot;!=&quot; ?
                        value != check :
                        type === &quot;^=&quot; ?
                        value.indexOf(check) === 0 :
                        type === &quot;$=&quot; ?
                        value.substr(value.length - check.length) === check :
                        type === &quot;|=&quot; ?
                        value === check || value.substr(0, check.length + 1) === check + &quot;-&quot; :
                        false;
        },
        POS: function(elem, match, i, array){
                var name = match[2], filter = Expr.setFilters[ name ];

                if ( filter ) {
                        return filter( elem, i, match, array );
                }
        }
}</pre>

<p>};</p>

<p>var origPOS = Expr.match.POS;</p>

<p>for ( var type in Expr.match ) {</p>

<pre class="ruby"><span class="ruby-constant">Expr</span>.<span class="ruby-identifier">match</span>[ <span class="ruby-identifier">type</span> ] = <span class="ruby-identifier">new</span> <span class="ruby-constant">RegExp</span>( <span class="ruby-constant">Expr</span>.<span class="ruby-identifier">match</span>[ <span class="ruby-identifier">type</span> ].<span class="ruby-identifier">source</span> <span class="ruby-operator">+</span> <span class="ruby-regexp">/(?![^\[]*\])(?![^\(]*\))/</span>.<span class="ruby-identifier">source</span> );
<span class="ruby-constant">Expr</span>.<span class="ruby-identifier">leftMatch</span>[ <span class="ruby-identifier">type</span> ] = <span class="ruby-identifier">new</span> <span class="ruby-constant">RegExp</span>( <span class="ruby-regexp">/(^(?:.|\r|\n)*?)/</span>.<span class="ruby-identifier">source</span> <span class="ruby-operator">+</span> <span class="ruby-constant">Expr</span>.<span class="ruby-identifier">match</span>[ <span class="ruby-identifier">type</span> ].<span class="ruby-identifier">source</span> );
</pre>

<p>}</p>

<p>var makeArray = function(array, results) {</p>

<pre>array = Array.prototype.slice.call( array, 0 );

if ( results ) {
        results.push.apply( results, array );
        return results;
}

return array;</pre>

<p>};</p>

<p>try {</p>

<pre class="ruby"><span class="ruby-constant">Array</span>.<span class="ruby-identifier">prototype</span>.<span class="ruby-identifier">slice</span>.<span class="ruby-identifier">call</span>( <span class="ruby-identifier">document</span>.<span class="ruby-identifier">documentElement</span>.<span class="ruby-identifier">childNodes</span>, <span class="ruby-value">0</span> );
</pre>

<p>} catch(e){</p>

<pre>makeArray = function(array, results) {
        var ret = results || [];

        if ( toString.call(array) === &quot;[object Array]&quot; ) {
                Array.prototype.push.apply( ret, array );
        } else {
                if ( typeof array.length === &quot;number&quot; ) {
                        for ( var i = 0, l = array.length; i &lt; l; i++ ) {
                                ret.push( array[i] );
                        }
                } else {
                        for ( var i = 0; array[i]; i++ ) {
                                ret.push( array[i] );
                        }
                }
        }

        return ret;
};</pre>

<p>}</p>

<p>var sortOrder;</p>

<p>if ( document.documentElement.compareDocumentPosition ) {</p>

<pre>sortOrder = function( a, b ) {
        if ( !a.compareDocumentPosition || !b.compareDocumentPosition ) {
                if ( a == b ) {
                        hasDuplicate = true;
                }
                return 0;
        }

        var ret = a.compareDocumentPosition(b) &amp; 4 ? -1 : a === b ? 0 : 1;
        if ( ret === 0 ) {
                hasDuplicate = true;
        }
        return ret;
};</pre>

<p>} else if ( “sourceIndex” in document.documentElement ) {</p>

<pre>sortOrder = function( a, b ) {
        if ( !a.sourceIndex || !b.sourceIndex ) {
                if ( a == b ) {
                        hasDuplicate = true;
                }
                return 0;
        }

        var ret = a.sourceIndex - b.sourceIndex;
        if ( ret === 0 ) {
                hasDuplicate = true;
        }
        return ret;
};</pre>

<p>} else if ( document.createRange ) {</p>

<pre>sortOrder = function( a, b ) {
        if ( !a.ownerDocument || !b.ownerDocument ) {
                if ( a == b ) {
                        hasDuplicate = true;
                }
                return 0;
        }

        var aRange = a.ownerDocument.createRange(), bRange = b.ownerDocument.createRange();
        aRange.setStart(a, 0);
        aRange.setEnd(a, 0);
        bRange.setStart(b, 0);
        bRange.setEnd(b, 0);
        var ret = aRange.compareBoundaryPoints(Range.START_TO_END, bRange);
        if ( ret === 0 ) {
                hasDuplicate = true;
        }
        return ret;
};</pre>

<p>}</p>

<p>(function(){</p>

<pre>var form = document.createElement(&quot;div&quot;),
        id = &quot;script&quot; + (new Date).getTime();
form.innerHTML = &quot;&lt;a name=&#39;&quot; + id + &quot;&#39;/&gt;&quot;;

var root = document.documentElement;
root.insertBefore( form, root.firstChild );

if ( !!document.getElementById( id ) ) {
        Expr.find.ID = function(match, context, isXML){
                if ( typeof context.getElementById !== &quot;undefined&quot; &amp;&amp; !isXML ) {
                        var m = context.getElementById(match[1]);
                        return m ? m.id === match[1] || typeof m.getAttributeNode !== &quot;undefined&quot; &amp;&amp; m.getAttributeNode(&quot;id&quot;).nodeValue === match[1] ? [m] : undefined : [];
                }
        };

        Expr.filter.ID = function(elem, match){
                var node = typeof elem.getAttributeNode !== &quot;undefined&quot; &amp;&amp; elem.getAttributeNode(&quot;id&quot;);
                return elem.nodeType === 1 &amp;&amp; node &amp;&amp; node.nodeValue === match;
        };
}

root.removeChild( form );
root = form = null; // release memory in IE</pre>

<p>})();</p>

<p>(function(){</p>

<pre>var div = document.createElement(&quot;div&quot;);
div.appendChild( document.createComment(&quot;&quot;) );

if ( div.getElementsByTagName(&quot;*&quot;).length &gt; 0 ) {
        Expr.find.TAG = function(match, context){
                var results = context.getElementsByTagName(match[1]);

                if ( match[1] === &quot;*&quot; ) {
                        var tmp = [];

                        for ( var i = 0; results[i]; i++ ) {
                                if ( results[i].nodeType === 1 ) {
                                        tmp.push( results[i] );
                                }
                        }

                        results = tmp;
                }

                return results;
        };
}

div.innerHTML = &quot;&lt;a href=&#39;#&#39;&gt;&lt;/a&gt;&quot;;
if ( div.firstChild &amp;&amp; typeof div.firstChild.getAttribute !== &quot;undefined&quot; &amp;&amp;
                div.firstChild.getAttribute(&quot;href&quot;) !== &quot;#&quot; ) {
        Expr.attrHandle.href = function(elem){
                return elem.getAttribute(&quot;href&quot;, 2);
        };
}

div = null; // release memory in IE</pre>

<p>})();</p>

<p>if ( document.querySelectorAll ) (function(){</p>

<pre>var oldSizzle = Sizzle, div = document.createElement(&quot;div&quot;);
div.innerHTML = &quot;&lt;p class=&#39;TEST&#39;&gt;&lt;/p&gt;&quot;;

if ( div.querySelectorAll &amp;&amp; div.querySelectorAll(&quot;.TEST&quot;).length === 0 ) {
        return;
}

Sizzle = function(query, context, extra, seed){
        context = context || document;

        if ( !seed &amp;&amp; context.nodeType === 9 &amp;&amp; !isXML(context) ) {
                try {
                        return makeArray( context.querySelectorAll(query), extra );
                } catch(e){}
        }

        return oldSizzle(query, context, extra, seed);
};

for ( var prop in oldSizzle ) {
        Sizzle[ prop ] = oldSizzle[ prop ];
}

div = null; // release memory in IE</pre>

<p>})();</p>

<p>if ( document.getElementsByClassName &amp;&amp;
document.documentElement.getElementsByClassName ) (function(){</p>

<pre>var div = document.createElement(&quot;div&quot;);
div.innerHTML = &quot;&lt;div class=&#39;test e&#39;&gt;&lt;/div&gt;&lt;div class=&#39;test&#39;&gt;&lt;/div&gt;&quot;;

if ( div.getElementsByClassName(&quot;e&quot;).length === 0 )
        return;

div.lastChild.className = &quot;e&quot;;

if ( div.getElementsByClassName(&quot;e&quot;).length === 1 )
        return;

Expr.order.splice(1, 0, &quot;CLASS&quot;);
Expr.find.CLASS = function(match, context, isXML) {
        if ( typeof context.getElementsByClassName !== &quot;undefined&quot; &amp;&amp; !isXML ) {
                return context.getElementsByClassName(match[1]);
        }
};

div = null; // release memory in IE</pre>

<p>})();</p>

<p>function dirNodeCheck( dir, cur, doneName, checkSet, nodeCheck, isXML ) {</p>

<pre>var sibDir = dir == &quot;previousSibling&quot; &amp;&amp; !isXML;
for ( var i = 0, l = checkSet.length; i &lt; l; i++ ) {
        var elem = checkSet[i];
        if ( elem ) {
                if ( sibDir &amp;&amp; elem.nodeType === 1 ){
                        elem.sizcache = doneName;
                        elem.sizset = i;
                }
                elem = elem[dir];
                var match = false;

                while ( elem ) {
                        if ( elem.sizcache === doneName ) {
                                match = checkSet[elem.sizset];
                                break;
                        }

                        if ( elem.nodeType === 1 &amp;&amp; !isXML ){
                                elem.sizcache = doneName;
                                elem.sizset = i;
                        }

                        if ( elem.nodeName === cur ) {
                                match = elem;
                                break;
                        }

                        elem = elem[dir];
                }

                checkSet[i] = match;
        }
}</pre>

<p>}</p>

<p>function dirCheck( dir, cur, doneName, checkSet, nodeCheck, isXML ) {</p>

<pre>var sibDir = dir == &quot;previousSibling&quot; &amp;&amp; !isXML;
for ( var i = 0, l = checkSet.length; i &lt; l; i++ ) {
        var elem = checkSet[i];
        if ( elem ) {
                if ( sibDir &amp;&amp; elem.nodeType === 1 ) {
                        elem.sizcache = doneName;
                        elem.sizset = i;
                }
                elem = elem[dir];
                var match = false;

                while ( elem ) {
                        if ( elem.sizcache === doneName ) {
                                match = checkSet[elem.sizset];
                                break;
                        }

                        if ( elem.nodeType === 1 ) {
                                if ( !isXML ) {
                                        elem.sizcache = doneName;
                                        elem.sizset = i;
                                }
                                if ( typeof cur !== &quot;string&quot; ) {
                                        if ( elem === cur ) {
                                                match = true;
                                                break;
                                        }

                                } else if ( Sizzle.filter( cur, [elem] ).length &gt; 0 ) {
                                        match = elem;
                                        break;
                                }
                        }

                        elem = elem[dir];
                }

                checkSet[i] = match;
        }
}</pre>

<p>}</p>

<p>var contains = document.compareDocumentPosition ?  function(a, b){</p>

<pre class="ruby"><span class="ruby-keyword">return</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">compareDocumentPosition</span>(<span class="ruby-identifier">b</span>) <span class="ruby-operator">&amp;</span> <span class="ruby-value">16</span>;
</pre>

<p>} : function(a, b){</p>

<pre>return a !== b &amp;&amp; (a.contains ? a.contains(b) : true);</pre>

<p>};</p>

<p>var isXML = function(elem){</p>

<pre>return elem.nodeType === 9 &amp;&amp; elem.documentElement.nodeName !== &quot;HTML&quot; ||
        !!elem.ownerDocument &amp;&amp; elem.ownerDocument.documentElement.nodeName !== &quot;HTML&quot;;</pre>

<p>};</p>

<p>var posProcess = function(selector, context){</p>

<pre>var tmpSet = [], later = &quot;&quot;, match,
        root = context.nodeType ? [context] : context;

while ( (match = Expr.match.PSEUDO.exec( selector )) ) {
        later += match[0];
        selector = selector.replace( Expr.match.PSEUDO, &quot;&quot; );
}

selector = Expr.relative[selector] ? selector + &quot;*&quot; : selector;

for ( var i = 0, l = root.length; i &lt; l; i++ ) {
        Sizzle( selector, root[i], tmpSet );
}

return Sizzle.filter( later, tmpSet );</pre>

<p>};</p>

<p>window.Sizzle = Sizzle;</p>

<p>})();</p>

<p>;(function(engine) {</p>

<pre class="ruby"><span class="ruby-identifier">var</span> <span class="ruby-identifier">extendElements</span> = <span class="ruby-constant">Prototype</span>.<span class="ruby-constant">Selector</span>.<span class="ruby-identifier">extendElements</span>;

<span class="ruby-identifier">function</span> <span class="ruby-identifier">select</span>(<span class="ruby-identifier">selector</span>, <span class="ruby-identifier">scope</span>) {
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">extendElements</span>(<span class="ruby-identifier">engine</span>(<span class="ruby-identifier">selector</span>, <span class="ruby-identifier">scope</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">document</span>));
}

<span class="ruby-identifier">function</span> <span class="ruby-identifier">match</span>(<span class="ruby-identifier">element</span>, <span class="ruby-identifier">selector</span>) {
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">engine</span>.<span class="ruby-identifier">matches</span>(<span class="ruby-identifier">selector</span>, [<span class="ruby-identifier">element</span>]).<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>;
}

<span class="ruby-constant">Prototype</span>.<span class="ruby-constant">Selector</span>.<span class="ruby-identifier">engine</span> = <span class="ruby-identifier">engine</span>;
<span class="ruby-constant">Prototype</span>.<span class="ruby-constant">Selector</span>.<span class="ruby-identifier">select</span> = <span class="ruby-identifier">select</span>;
<span class="ruby-constant">Prototype</span>.<span class="ruby-constant">Selector</span>.<span class="ruby-identifier">match</span> = <span class="ruby-identifier">match</span>;
</pre>

<p>})(Sizzle);</p>

<p>window.Sizzle = Prototype._original_property; delete
Prototype._original_property;</p>

<p>var Form = {</p>

<pre>reset: function(form) {
  form = $(form);
  form.reset();
  return form;
},

serializeElements: function(elements, options) {
  if (typeof options != &#39;object&#39;) options = { hash: !!options };
  else if (Object.isUndefined(options.hash)) options.hash = true;
  var key, value, submitted = false, submit = options.submit;

  var data = elements.inject({ }, function(result, element) {
    if (!element.disabled &amp;&amp; element.name) {
      key = element.name; value = $(element).getValue();
      if (value != null &amp;&amp; element.type != &#39;file&#39; &amp;&amp; (element.type != &#39;submit&#39; || (!submitted &amp;&amp;
          submit !== false &amp;&amp; (!submit || key == submit) &amp;&amp; (submitted = true)))) {
        if (key in result) {
          if (!Object.isArray(result[key])) result[key] = [result[key]];
          result[key].push(value);
        }
        else result[key] = value;
      }
    }
    return result;
  });

  return options.hash ? data : Object.toQueryString(data);
}</pre>

<p>};</p>

<p>Form.Methods = {</p>

<pre>serialize: function(form, options) {
  return Form.serializeElements(Form.getElements(form), options);
},

getElements: function(form) {
  var elements = $(form).getElementsByTagName(&#39;*&#39;),
      element,
      arr = [ ],
      serializers = Form.Element.Serializers;
  for (var i = 0; element = elements[i]; i++) {
    arr.push(element);
  }
  return arr.inject([], function(elements, child) {
    if (serializers[child.tagName.toLowerCase()])
      elements.push(Element.extend(child));
    return elements;
  })
},

getInputs: function(form, typeName, name) {
  form = $(form);
  var inputs = form.getElementsByTagName(&#39;input&#39;);

  if (!typeName &amp;&amp; !name) return $A(inputs).map(Element.extend);

  for (var i = 0, matchingInputs = [], length = inputs.length; i &lt; length; i++) {
    var input = inputs[i];
    if ((typeName &amp;&amp; input.type != typeName) || (name &amp;&amp; input.name != name))
      continue;
    matchingInputs.push(Element.extend(input));
  }

  return matchingInputs;
},

disable: function(form) {
  form = $(form);
  Form.getElements(form).invoke(&#39;disable&#39;);
  return form;
},

enable: function(form) {
  form = $(form);
  Form.getElements(form).invoke(&#39;enable&#39;);
  return form;
},

findFirstElement: function(form) {
  var elements = $(form).getElements().findAll(function(element) {
    return &#39;hidden&#39; != element.type &amp;&amp; !element.disabled;
  });
  var firstByIndex = elements.findAll(function(element) {
    return element.hasAttribute(&#39;tabIndex&#39;) &amp;&amp; element.tabIndex &gt;= 0;
  }).sortBy(function(element) { return element.tabIndex }).first();

  return firstByIndex ? firstByIndex : elements.find(function(element) {
    return /^(?:input|select|textarea)$/i.test(element.tagName);
  });
},

focusFirstElement: function(form) {
  form = $(form);
  form.findFirstElement().activate();
  return form;
},

request: function(form, options) {
  form = $(form), options = Object.clone(options || { });

  var params = options.parameters, action = form.readAttribute(&#39;action&#39;) || &#39;&#39;;
  if (action.blank()) action = window.location.href;
  options.parameters = form.serialize(true);

  if (params) {
    if (Object.isString(params)) params = params.toQueryParams();
    Object.extend(options.parameters, params);
  }

  if (form.hasAttribute(&#39;method&#39;) &amp;&amp; !options.method)
    options.method = form.method;

  return new Ajax.Request(action, options);
}</pre>

<p>};</p>

<p>/<strong>————————————————————————–</strong>/</p>

<p>Form.Element = {</p>

<pre>focus: function(element) {
  $(element).focus();
  return element;
},

select: function(element) {
  $(element).select();
  return element;
}</pre>

<p>};</p>

<p>Form.Element.Methods = {</p>

<pre>serialize: function(element) {
  element = $(element);
  if (!element.disabled &amp;&amp; element.name) {
    var value = element.getValue();
    if (value != undefined) {
      var pair = { };
      pair[element.name] = value;
      return Object.toQueryString(pair);
    }
  }
  return &#39;&#39;;
},

getValue: function(element) {
  element = $(element);
  var method = element.tagName.toLowerCase();
  return Form.Element.Serializers[method](element);
},

setValue: function(element, value) {
  element = $(element);
  var method = element.tagName.toLowerCase();
  Form.Element.Serializers[method](element, value);
  return element;
},

clear: function(element) {
  $(element).value = &#39;&#39;;
  return element;
},

present: function(element) {
  return $(element).value != &#39;&#39;;
},

activate: function(element) {
  element = $(element);
  try {
    element.focus();
    if (element.select &amp;&amp; (element.tagName.toLowerCase() != &#39;input&#39; ||
        !(/^(?:button|reset|submit)$/i.test(element.type))))
      element.select();
  } catch (e) { }
  return element;
},

disable: function(element) {
  element = $(element);
  element.disabled = true;
  return element;
},

enable: function(element) {
  element = $(element);
  element.disabled = false;
  return element;
}</pre>

<p>};</p>

<p>/<strong>————————————————————————–</strong>/</p>

<p>var Field = Form.Element;</p>

<p>var $F = Form.Element.Methods.getValue;</p>

<p>/<strong>————————————————————————–</strong>/</p>

<p>Form.Element.Serializers = {</p>

<pre>input: function(element, value) {
  switch (element.type.toLowerCase()) {
    case &#39;checkbox&#39;:
    case &#39;radio&#39;:
      return Form.Element.Serializers.inputSelector(element, value);
    default:
      return Form.Element.Serializers.textarea(element, value);
  }
},

inputSelector: function(element, value) {
  if (Object.isUndefined(value)) return element.checked ? element.value : null;
  else element.checked = !!value;
},

textarea: function(element, value) {
  if (Object.isUndefined(value)) return element.value;
  else element.value = value;
},

select: function(element, value) {
  if (Object.isUndefined(value))
    return this[element.type == &#39;select-one&#39; ?
      &#39;selectOne&#39; : &#39;selectMany&#39;](element);
  else {
    var opt, currentValue, single = !Object.isArray(value);
    for (var i = 0, length = element.length; i &lt; length; i++) {
      opt = element.options[i];
      currentValue = this.optionValue(opt);
      if (single) {
        if (currentValue == value) {
          opt.selected = true;
          return;
        }
      }
      else opt.selected = value.include(currentValue);
    }
  }
},

selectOne: function(element) {
  var index = element.selectedIndex;
  return index &gt;= 0 ? this.optionValue(element.options[index]) : null;
},

selectMany: function(element) {
  var values, length = element.length;
  if (!length) return null;

  for (var i = 0, values = []; i &lt; length; i++) {
    var opt = element.options[i];
    if (opt.selected) values.push(this.optionValue(opt));
  }
  return values;
},

optionValue: function(opt) {
  return Element.extend(opt).hasAttribute(&#39;value&#39;) ? opt.value : opt.text;
}</pre>

<p>};</p>

<p>/<strong>————————————————————————–</strong>/</p>

<p>Abstract.TimedObserver = Class.create(PeriodicalExecuter, {</p>

<pre>initialize: function($super, element, frequency, callback) {
  $super(callback, frequency);
  this.element   = $(element);
  this.lastValue = this.getValue();
},

execute: function() {
  var value = this.getValue();
  if (Object.isString(this.lastValue) &amp;&amp; Object.isString(value) ?
      this.lastValue != value : String(this.lastValue) != String(value)) {
    this.callback(this.element, value);
    this.lastValue = value;
  }
}</pre>

<p>});</p>

<p>Form.Element.Observer = Class.create(Abstract.TimedObserver, {</p>

<pre>getValue: function() {
  return Form.Element.getValue(this.element);
}</pre>

<p>});</p>

<p>Form.Observer = Class.create(Abstract.TimedObserver, {</p>

<pre>getValue: function() {
  return Form.serialize(this.element);
}</pre>

<p>});</p>

<p>/<strong>————————————————————————–</strong>/</p>

<p>Abstract.EventObserver = Class.create({</p>

<pre>initialize: function(element, callback) {
  this.element  = $(element);
  this.callback = callback;

  this.lastValue = this.getValue();
  if (this.element.tagName.toLowerCase() == &#39;form&#39;)
    this.registerFormCallbacks();
  else
    this.registerCallback(this.element);
},

onElementEvent: function() {
  var value = this.getValue();
  if (this.lastValue != value) {
    this.callback(this.element, value);
    this.lastValue = value;
  }
},

registerFormCallbacks: function() {
  Form.getElements(this.element).each(this.registerCallback, this);
},

registerCallback: function(element) {
  if (element.type) {
    switch (element.type.toLowerCase()) {
      case &#39;checkbox&#39;:
      case &#39;radio&#39;:
        Event.observe(element, &#39;click&#39;, this.onElementEvent.bind(this));
        break;
      default:
        Event.observe(element, &#39;change&#39;, this.onElementEvent.bind(this));
        break;
    }
  }
}</pre>

<p>});</p>

<p>Form.Element.EventObserver = Class.create(Abstract.EventObserver, {</p>

<pre>getValue: function() {
  return Form.Element.getValue(this.element);
}</pre>

<p>});</p>

<p>Form.EventObserver = Class.create(Abstract.EventObserver, {</p>

<pre>getValue: function() {
  return Form.serialize(this.element);
}</pre>

<p>}); (function() {</p>

<pre>var Event = {
  KEY_BACKSPACE: 8,
  KEY_TAB:       9,
  KEY_RETURN:   13,
  KEY_ESC:      27,
  KEY_LEFT:     37,
  KEY_UP:       38,
  KEY_RIGHT:    39,
  KEY_DOWN:     40,
  KEY_DELETE:   46,
  KEY_HOME:     36,
  KEY_END:      35,
  KEY_PAGEUP:   33,
  KEY_PAGEDOWN: 34,
  KEY_INSERT:   45,

  cache: {}
};

var docEl = document.documentElement;
var MOUSEENTER_MOUSELEAVE_EVENTS_SUPPORTED = &#39;onmouseenter&#39; in docEl
  &amp;&amp; &#39;onmouseleave&#39; in docEl;

var _isButton;
if (Prototype.Browser.IE) {
  var buttonMap = { 0: 1, 1: 4, 2: 2 };
  _isButton = function(event, code) {
    return event.button === buttonMap[code];
  };
} else if (Prototype.Browser.WebKit) {
  _isButton = function(event, code) {
    switch (code) {
      case 0: return event.which == 1 &amp;&amp; !event.metaKey;
      case 1: return event.which == 1 &amp;&amp; event.metaKey;
      default: return false;
    }
  };
} else {
  _isButton = function(event, code) {
    return event.which ? (event.which === code + 1) : (event.button === code);
  };
}

function isLeftClick(event)   { return _isButton(event, 0) }

function isMiddleClick(event) { return _isButton(event, 1) }

function isRightClick(event)  { return _isButton(event, 2) }

function element(event) {
  event = Event.extend(event);

  var node = event.target, type = event.type,
   currentTarget = event.currentTarget;

  if (currentTarget &amp;&amp; currentTarget.tagName) {
    if (type === &#39;load&#39; || type === &#39;error&#39; ||
      (type === &#39;click&#39; &amp;&amp; currentTarget.tagName.toLowerCase() === &#39;input&#39;
        &amp;&amp; currentTarget.type === &#39;radio&#39;))
          node = currentTarget;
  }

  if (node.nodeType == Node.TEXT_NODE)
    node = node.parentNode;

  return Element.extend(node);
}

function findElement(event, expression) {
  var element = Event.element(event);
  if (!expression) return element;
  while (element) {
    if (Object.isElement(element) &amp;&amp; Prototype.Selector.match(element, expression)) {
      return Element.extend(element);
    }
    element = element.parentNode;
  }
}

function pointer(event) {
  return { x: pointerX(event), y: pointerY(event) };
}

function pointerX(event) {
  var docElement = document.documentElement,
   body = document.body || { scrollLeft: 0 };

  return event.pageX || (event.clientX +
    (docElement.scrollLeft || body.scrollLeft) -
    (docElement.clientLeft || 0));
}

function pointerY(event) {
  var docElement = document.documentElement,
   body = document.body || { scrollTop: 0 };

  return  event.pageY || (event.clientY +
     (docElement.scrollTop || body.scrollTop) -
     (docElement.clientTop || 0));
}

function stop(event) {
  Event.extend(event);
  event.preventDefault();
  event.stopPropagation();

  event.stopped = true;
}

Event.Methods = {
  isLeftClick: isLeftClick,
  isMiddleClick: isMiddleClick,
  isRightClick: isRightClick,

  element: element,
  findElement: findElement,

  pointer: pointer,
  pointerX: pointerX,
  pointerY: pointerY,

  stop: stop
};

var methods = Object.keys(Event.Methods).inject({ }, function(m, name) {
  m[name] = Event.Methods[name].methodize();
  return m;
});

if (Prototype.Browser.IE) {
  function _relatedTarget(event) {
    var element;
    switch (event.type) {
      case &#39;mouseover&#39;: element = event.fromElement; break;
      case &#39;mouseout&#39;:  element = event.toElement;   break;
      default: return null;
    }
    return Element.extend(element);
  }

  Object.extend(methods, {
    stopPropagation: function() { this.cancelBubble = true },
    preventDefault:  function() { this.returnValue = false },
    inspect: function() { return &#39;[object Event]&#39; }
  });

  Event.extend = function(event, element) {
    if (!event) return false;
    if (event._extendedByPrototype) return event;

    event._extendedByPrototype = Prototype.emptyFunction;
    var pointer = Event.pointer(event);

    Object.extend(event, {
      target: event.srcElement || element,
      relatedTarget: _relatedTarget(event),
      pageX:  pointer.x,
      pageY:  pointer.y
    });

    return Object.extend(event, methods);
  };
} else {
  Event.prototype = window.Event.prototype || document.createEvent(&#39;HTMLEvents&#39;).__proto__;
  Object.extend(Event.prototype, methods);
  Event.extend = Prototype.K;
}

function _createResponder(element, eventName, handler) {
  var registry = Element.retrieve(element, &#39;prototype_event_registry&#39;);

  if (Object.isUndefined(registry)) {
    CACHE.push(element);
    registry = Element.retrieve(element, &#39;prototype_event_registry&#39;, $H());
  }

  var respondersForEvent = registry.get(eventName);
  if (Object.isUndefined(respondersForEvent)) {
    respondersForEvent = [];
    registry.set(eventName, respondersForEvent);
  }

  if (respondersForEvent.pluck(&#39;handler&#39;).include(handler)) return false;

  var responder;
  if (eventName.include(&quot;:&quot;)) {
    responder = function(event) {
      if (Object.isUndefined(event.eventName))
        return false;

      if (event.eventName !== eventName)
        return false;

      Event.extend(event, element);
      handler.call(element, event);
    };
  } else {
    if (!MOUSEENTER_MOUSELEAVE_EVENTS_SUPPORTED &amp;&amp;
     (eventName === &quot;mouseenter&quot; || eventName === &quot;mouseleave&quot;)) {
      if (eventName === &quot;mouseenter&quot; || eventName === &quot;mouseleave&quot;) {
        responder = function(event) {
          Event.extend(event, element);

          var parent = event.relatedTarget;
          while (parent &amp;&amp; parent !== element) {
            try { parent = parent.parentNode; }
            catch(e) { parent = element; }
          }

          if (parent === element) return;

          handler.call(element, event);
        };
      }
    } else {
      responder = function(event) {
        Event.extend(event, element);
        handler.call(element, event);
      };
    }
  }

  responder.handler = handler;
  respondersForEvent.push(responder);
  return responder;
}

function _destroyCache() {
  for (var i = 0, length = CACHE.length; i &lt; length; i++) {
    Event.stopObserving(CACHE[i]);
    CACHE[i] = null;
  }
}

var CACHE = [];

if (Prototype.Browser.IE)
  window.attachEvent(&#39;onunload&#39;, _destroyCache);

if (Prototype.Browser.WebKit)
  window.addEventListener(&#39;unload&#39;, Prototype.emptyFunction, false);

var _getDOMEventName = Prototype.K,
    translations = { mouseenter: &quot;mouseover&quot;, mouseleave: &quot;mouseout&quot; };

if (!MOUSEENTER_MOUSELEAVE_EVENTS_SUPPORTED) {
  _getDOMEventName = function(eventName) {
    return (translations[eventName] || eventName);
  };
}

function observe(element, eventName, handler) {
  element = $(element);

  var responder = _createResponder(element, eventName, handler);

  if (!responder) return element;

  if (eventName.include(&#39;:&#39;)) {
    if (element.addEventListener)
      element.addEventListener(&quot;dataavailable&quot;, responder, false);
    else {
      element.attachEvent(&quot;ondataavailable&quot;, responder);
      element.attachEvent(&quot;onfilterchange&quot;, responder);
    }
  } else {
    var actualEventName = _getDOMEventName(eventName);

    if (element.addEventListener)
      element.addEventListener(actualEventName, responder, false);
    else
      element.attachEvent(&quot;on&quot; + actualEventName, responder);
  }

  return element;
}

function stopObserving(element, eventName, handler) {
  element = $(element);

  var registry = Element.retrieve(element, &#39;prototype_event_registry&#39;);
  if (!registry) return element;

  if (!eventName) {
    registry.each( function(pair) {
      var eventName = pair.key;
      stopObserving(element, eventName);
    });
    return element;
  }

  var responders = registry.get(eventName);
  if (!responders) return element;

  if (!handler) {
    responders.each(function(r) {
      stopObserving(element, eventName, r.handler);
    });
    return element;
  }

  var responder = responders.find( function(r) { return r.handler === handler; });
  if (!responder) return element;

  if (eventName.include(&#39;:&#39;)) {
    if (element.removeEventListener)
      element.removeEventListener(&quot;dataavailable&quot;, responder, false);
    else {
      element.detachEvent(&quot;ondataavailable&quot;, responder);
      element.detachEvent(&quot;onfilterchange&quot;,  responder);
    }
  } else {
    var actualEventName = _getDOMEventName(eventName);
    if (element.removeEventListener)
      element.removeEventListener(actualEventName, responder, false);
    else
      element.detachEvent(&#39;on&#39; + actualEventName, responder);
  }

  registry.set(eventName, responders.without(responder));

  return element;
}

function fire(element, eventName, memo, bubble) {
  element = $(element);

  if (Object.isUndefined(bubble))
    bubble = true;

  if (element == document &amp;&amp; document.createEvent &amp;&amp; !element.dispatchEvent)
    element = document.documentElement;

  var event;
  if (document.createEvent) {
    event = document.createEvent(&#39;HTMLEvents&#39;);
    event.initEvent(&#39;dataavailable&#39;, true, true);
  } else {
    event = document.createEventObject();
    event.eventType = bubble ? &#39;ondataavailable&#39; : &#39;onfilterchange&#39;;
  }

  event.eventName = eventName;
  event.memo = memo || { };

  if (document.createEvent)
    element.dispatchEvent(event);
  else
    element.fireEvent(event.eventType, event);

  return Event.extend(event);
}

Event.Handler = Class.create({
  initialize: function(element, eventName, selector, callback) {
    this.element   = $(element);
    this.eventName = eventName;
    this.selector  = selector;
    this.callback  = callback;
    this.handler   = this.handleEvent.bind(this);
  },

  start: function() {
    Event.observe(this.element, this.eventName, this.handler);
    return this;
  },

  stop: function() {
    Event.stopObserving(this.element, this.eventName, this.handler);
    return this;
  },

  handleEvent: function(event) {
    var element = event.findElement(this.selector);
    if (element) this.callback.call(this.element, event, element);
  }
});

function on(element, eventName, selector, callback) {
  element = $(element);
  if (Object.isFunction(selector) &amp;&amp; Object.isUndefined(callback)) {
    callback = selector, selector = null;
  }

  return new Event.Handler(element, eventName, selector, callback).start();
}

Object.extend(Event, Event.Methods);

Object.extend(Event, {
  fire:          fire,
  observe:       observe,
  stopObserving: stopObserving,
  on:            on
});

Element.addMethods({
  fire:          fire,

  observe:       observe,

  stopObserving: stopObserving,

  on:            on
});

Object.extend(document, {
  fire:          fire.methodize(),

  observe:       observe.methodize(),

  stopObserving: stopObserving.methodize(),

  on:            on.methodize(),

  loaded:        false
});

if (window.Event) Object.extend(window.Event, Event);
else window.Event = Event;</pre>

<p>})();</p>

<p>(function() {</p>

<pre>/* Support for the DOMContentLoaded event is based on work by Dan Webb,
   Matthias Miller, Dean Edwards, John Resig, and Diego Perini. */

var timer;

function fireContentLoadedEvent() {
  if (document.loaded) return;
  if (timer) window.clearTimeout(timer);
  document.loaded = true;
  document.fire(&#39;dom:loaded&#39;);
}

function checkReadyState() {
  if (document.readyState === &#39;complete&#39;) {
    document.stopObserving(&#39;readystatechange&#39;, checkReadyState);
    fireContentLoadedEvent();
  }
}

function pollDoScroll() {
  try { document.documentElement.doScroll(&#39;left&#39;); }
  catch(e) {
    timer = pollDoScroll.defer();
    return;
  }
  fireContentLoadedEvent();
}

if (document.addEventListener) {
  document.addEventListener(&#39;DOMContentLoaded&#39;, fireContentLoadedEvent, false);
} else {
  document.observe(&#39;readystatechange&#39;, checkReadyState);
  if (window == top)
    timer = pollDoScroll.defer();
}

Event.observe(window, &#39;load&#39;, fireContentLoadedEvent);</pre>

<p>})();</p>

<p>Element.addMethods();</p>

<p>/*——————————- DEPRECATED ——————————-*/</p>

<p>Hash.toQueryString = Object.toQueryString;</p>

<p>var Toggle = { display: Element.toggle };</p>

<p>Element.Methods.childOf = Element.Methods.descendantOf;</p>

<p>var Insertion = {</p>

<pre>Before: function(element, content) {
  return Element.insert(element, {before:content});
},

Top: function(element, content) {
  return Element.insert(element, {top:content});
},

Bottom: function(element, content) {
  return Element.insert(element, {bottom:content});
},

After: function(element, content) {
  return Element.insert(element, {after:content});
}</pre>

<p>};</p>

<p>var $continue = new Error(&#39;“throw $continue” is deprecated, use
“return” instead&#39;);</p>

<p>var Position = {</p>

<pre>includeScrollOffsets: false,

prepare: function() {
  this.deltaX =  window.pageXOffset
              || document.documentElement.scrollLeft
              || document.body.scrollLeft
              || 0;
  this.deltaY =  window.pageYOffset
              || document.documentElement.scrollTop
              || document.body.scrollTop
              || 0;
},

within: function(element, x, y) {
  if (this.includeScrollOffsets)
    return this.withinIncludingScrolloffsets(element, x, y);
  this.xcomp = x;
  this.ycomp = y;
  this.offset = Element.cumulativeOffset(element);

  return (y &gt;= this.offset[1] &amp;&amp;
          y &lt;  this.offset[1] + element.offsetHeight &amp;&amp;
          x &gt;= this.offset[0] &amp;&amp;
          x &lt;  this.offset[0] + element.offsetWidth);
},

withinIncludingScrolloffsets: function(element, x, y) {
  var offsetcache = Element.cumulativeScrollOffset(element);

  this.xcomp = x + offsetcache[0] - this.deltaX;
  this.ycomp = y + offsetcache[1] - this.deltaY;
  this.offset = Element.cumulativeOffset(element);

  return (this.ycomp &gt;= this.offset[1] &amp;&amp;
          this.ycomp &lt;  this.offset[1] + element.offsetHeight &amp;&amp;
          this.xcomp &gt;= this.offset[0] &amp;&amp;
          this.xcomp &lt;  this.offset[0] + element.offsetWidth);
},

overlap: function(mode, element) {
  if (!mode) return 0;
  if (mode == &#39;vertical&#39;)
    return ((this.offset[1] + element.offsetHeight) - this.ycomp) /
      element.offsetHeight;
  if (mode == &#39;horizontal&#39;)
    return ((this.offset[0] + element.offsetWidth) - this.xcomp) /
      element.offsetWidth;
},

cumulativeOffset: Element.Methods.cumulativeOffset,

positionedOffset: Element.Methods.positionedOffset,

absolutize: function(element) {
  Position.prepare();
  return Element.absolutize(element);
},

relativize: function(element) {
  Position.prepare();
  return Element.relativize(element);
},

realOffset: Element.Methods.cumulativeScrollOffset,

offsetParent: Element.Methods.getOffsetParent,

page: Element.Methods.viewportOffset,

clone: function(source, target, options) {
  options = options || { };
  return Element.clonePosition(target, source, options);
}</pre>

<p>};</p>

<p>/<strong>————————————————————————–</strong>/</p>

<p>if (!document.getElementsByClassName) document.getElementsByClassName =
function(instanceMethods){</p>

<pre>function iter(name) {
  return name.blank() ? null : &quot;[contains(concat(&#39; &#39;, @class, &#39; &#39;), &#39; &quot; + name + &quot; &#39;)]&quot;;
}

instanceMethods.getElementsByClassName = Prototype.BrowserFeatures.XPath ?
function(element, className) {
  className = className.toString().strip();
  var cond = /\s/.test(className) ? $w(className).map(iter).join(&#39;&#39;) : iter(className);
  return cond ? document._getElementsByXPath(&#39;.//*&#39; + cond, element) : [];
} : function(element, className) {
  className = className.toString().strip();
  var elements = [], classNames = (/\s/.test(className) ? $w(className) : null);
  if (!classNames &amp;&amp; !className) return elements;

  var nodes = $(element).getElementsByTagName(&#39;*&#39;);
  className = &#39; &#39; + className + &#39; &#39;;

  for (var i = 0, child, cn; child = nodes[i]; i++) {
    if (child.className &amp;&amp; (cn = &#39; &#39; + child.className + &#39; &#39;) &amp;&amp; (cn.include(className) ||
        (classNames &amp;&amp; classNames.all(function(name) {
          return !name.toString().blank() &amp;&amp; cn.include(&#39; &#39; + name + &#39; &#39;);
        }))))
      elements.push(Element.extend(child));
  }
  return elements;
};

return function(className, parentElement) {
  return $(parentElement || document.body).getElementsByClassName(className);
};</pre>

<p>}(Element.Methods);</p>

<p>/<strong>————————————————————————–</strong>/</p>

<p>Element.ClassNames = Class.create(); Element.ClassNames.prototype = {</p>

<pre>initialize: function(element) {
  this.element = $(element);
},

_each: function(iterator) {
  this.element.className.split(/\s+/).select(function(name) {
    return name.length &gt; 0;
  })._each(iterator);
},

set: function(className) {
  this.element.className = className;
},

add: function(classNameToAdd) {
  if (this.include(classNameToAdd)) return;
  this.set($A(this).concat(classNameToAdd).join(&#39; &#39;));
},

remove: function(classNameToRemove) {
  if (!this.include(classNameToRemove)) return;
  this.set($A(this).without(classNameToRemove).join(&#39; &#39;));
},

toString: function() {
  return $A(this).join(&#39; &#39;);
}</pre>

<p>};</p>

<p>Object.extend(Element.ClassNames.prototype, Enumerable);</p>

<p>/<strong>————————————————————————–</strong>/</p>

<p>(function() {</p>

<pre>window.Selector = Class.create({
  initialize: function(expression) {
    this.expression = expression.strip();
  },

  findElements: function(rootElement) {
    return Prototype.Selector.select(this.expression, rootElement);
  },

  match: function(element) {
    return Prototype.Selector.match(element, this.expression);
  },

  toString: function() {
    return this.expression;
  },

  inspect: function() {
    return &quot;#&lt;Selector: &quot; + this.expression + &quot;&gt;&quot;;
  }
});

Object.extend(Selector, {
  matchElements: function(elements, expression) {
    var match = Prototype.Selector.match,
        results = [];

    for (var i = 0, length = elements.length; i &lt; length; i++) {
      var element = elements[i];
      if (match(element, expression)) {
        results.push(Element.extend(element));
      }
    }
    return results;
  },

  findElement: function(elements, expression, index) {
    index = index || 0;
    var matchIndex = 0, element;
    for (var i = 0, length = elements.length; i &lt; length; i++) {
      element = elements[i];
      if (Prototype.Selector.match(element, expression) &amp;&amp; index === matchIndex++) {
        return Element.extend(element);
      }
    }
  },

  findChildElements: function(element, expressions) {
    var selector = expressions.toArray().join(&#39;, &#39;);
    return Prototype.Selector.select(selector, element || document);
  }
});</pre>

<p>})();</p>
</main>



<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="http://docs.seattlerb.org/rdoc/">RDoc</a> 4.2.0.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

